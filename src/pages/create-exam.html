<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="client-id" content="seatos">
    <title>Create Exam - CBT Exam</title>
    <link rel="manifest" href="../manifest.json">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        .mobile-text {
            display: none;
        }

        .desktop-text {
            display: inline;
        }

        .mobile-user-row {
            display: none;
            width: 100%;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .mobile-user-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        /* Cancel Button Styling */
        .btn-cancel {
            color: #c62828 !important;
            border: 1px solid #ef5350 !important;
            background-color: transparent;
        }

        .btn-cancel:hover {
            background-color: rgba(239, 83, 80, 0.1) !important;
        }

        /* Mobile Logout Button */
        .btn-logout-mobile {
            padding: 6px 12px;
            font-size: 0.9rem;
            color: var(--text-color);
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-logout-mobile:hover {
            background: var(--inner-bg);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        @media (max-width: 600px) {
            .mobile-text {
                display: inline;
            }

            .desktop-text {
                display: none;
            }

            /* Mobile Header Layout - Two Rows */
            /* Mobile Header Layout - Two Rows as Blocks */
            .main-header {
                display: block !important;
                padding: 12px 15px;
                height: auto;
            }

            /* First Row Container */
            .header-top-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                margin-bottom: 10px;
            }

            /* Logo Group (Left Side) */
            .logo {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 0;
                /* Reset margins since we use header-top-row now */
            }

            .logo h1 {
                font-size: 1.1rem;
                margin: 0;
            }

            /* Back button (Right Side) */
            .btn-back-dashboard.mobile-only {
                padding: 6px !important;
                /* Square-ish shape for icon */
                width: 36px;
                height: 36px;
                min-width: auto !important;
                background: transparent !important;
                border: 1px solid var(--border-color) !important;
                color: var(--text-color) !important;
                border-radius: 8px;
                display: flex !important;
                align-items: center;
                justify-content: center;
                margin-left: 10px;
            }

            .btn-back-dashboard.mobile-only svg {
                width: 20px;
                height: 20px;
                stroke: currentColor;
            }

            .btn-back-dashboard.mobile-only:hover {
                background: var(--inner-bg) !important;
                border-color: var(--primary-color) !important;
                color: var(--primary-color) !important;
            }

            /* Hide desktop user menu */
            .user-menu.desktop-only {
                display: none !important;
            }

            /* Second Row: Teacher Name (left) + Dark Mode (right) */
            .mobile-user-row {
                display: flex !important;
            }

            #user-desktop-name {
                display: none;
            }

            /* Questions Header */
            .section-header-questions {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .section-header-questions .actions {
                width: 100%;
                display: flex;
                gap: 10px;
            }

            .section-header-questions .actions .btn {
                flex: 1;
                text-align: center;
                margin-right: 0 !important;
            }

            /* Footer Actions Mobile */
            .form-actions {
                display: flex !important;
                flex-direction: row !important;
                /* Side by side */
                justify-content: space-between;
                gap: 10%;
                /* 10% gap as requested */
                margin-top: 20px;
            }

            .form-actions .btn {
                flex: 1;
                /* Stretch to fill available width */
                min-width: 0;
                /* Prevent overflow */
                padding: 12px;
                font-size: 1rem;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            /* Scheduling Options - Stack vertically on mobile */
            .scheduling-options-row {
                flex-direction: column !important;
            }

            .scheduling-options-row .form-col {
                width: 100% !important;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="main-header">
            <!-- First Row Main Header -->
            <div class="header-top-row">
                <!-- Left: Logo & Title Group -->
                <div class="logo">
                    <!-- Logo Image will be injected here by themeApplier -->
                    <h1 class="logo-text">Create New Exam</h1>
                </div>

                <!-- Right: Back Button -->
                <a href="teacher-dashboard.html" class="btn btn-outline btn-back-dashboard mobile-only"
                    aria-label="Back to Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                </a>
            </div>

            <!-- Desktop user menu -->
            <div class="user-menu desktop-only">
                <span id="user-desktop-name" style="margin-right: 15px; font-weight:bold;">Teacher</span>
                <a href="teacher-dashboard.html" class="btn btn-outline btn-back-dashboard">
                    <span class="desktop-text">‚Üê Back to Dashboard</span>
                </a>
            </div>

            <!-- Second Row: Teacher name (left) + Dark mode toggle (right) -->
            <div class="mobile-user-row">
                <button onclick="auth.logout()" class="btn-logout-mobile">
                    <span>üö™ Logout</span>
                </button>
                <!-- Dark mode toggle will be injected here by utils.js -->
            </div>
        </header>

        <main class="main-content" style="display: block;">
            <form id="create-exam-form">
                <!-- Step 1: Metadata -->
                <div class="form-section">
                    <div class="section-header">
                        <h3>Exam Details</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-title">Term</label>
                                <input type="text" id="exam-title" class="form-control" required
                                    placeholder="e.g. 1st Term Mid-Term Mathematics">
                            </div>
                        </div>
                        <div class="form-col">
                            <!-- spacer -->
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-school-level">School Level</label>
                                <select id="exam-school-level" class="form-control" required>
                                    <option value="">Select School Level</option>
                                    <option value="secondary">Secondary School</option>
                                    <option value="primary">Primary School</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-subject">Subject</label>
                                <select id="exam-subject" class="form-control" required disabled>
                                    <option value="">Select school level first</option>
                                </select>
                                <p id="subject-hint"
                                    style="font-size: 0.8rem; color: var(--light-text); margin-top: 5px; display: none;">
                                    Please select a school level to see available subjects
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-target-class">Target Class</label>
                                <select id="exam-target-class" class="form-control" required>
                                    <option value="All">All Classes</option>
                                    <option value="JSS1">JSS 1</option>
                                    <option value="JSS2">JSS 2</option>
                                    <option value="JSS3">JSS 3</option>
                                    <option value="SS1">SS 1</option>
                                    <option value="SS2">SS 2</option>
                                    <option value="SS3">SS 3</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <!-- spacer -->
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-duration">Duration (Minutes)</label>
                                <input type="number" id="exam-duration" class="form-control" min="5" value="30"
                                    required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-pass-score">Passing Score (%)</label>
                                <input type="number" id="exam-pass-score" class="form-control" min="0" max="100"
                                    value="50" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="exam-instructions">General Instructions</label>
                        <textarea id="exam-instructions" class="form-control" rows="3"
                            placeholder="Enter general instructions for students..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="exam-theory-instructions">Theory Section Instructions (Optional)</label>
                        <textarea id="exam-theory-instructions" class="form-control" rows="3"
                            placeholder="Enter specific instructions for theory questions (e.g., 'Answer in detail', 'Minimum 200 words', etc.)"></textarea>
                        <p style="font-size: 0.8rem; color: var(--light-text); margin-top: 5px;">
                            These instructions will be displayed at the beginning of the theory section
                        </p>
                    </div>

                    <!-- Scheduling and Options -->
                    <div class="form-row scheduling-options-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-scheduled-date">Scheduled Date & Time</label>
                                <input type="datetime-local" id="exam-scheduled-date" class="form-control"
                                    title="Leave empty to make exam immediately available">
                                <p style="font-size: 0.8rem; color: var(--light-text); margin-top: 5px;">
                                    Leave empty for immediate availability
                                </p>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label style="margin-bottom: 10px; display: block;">Question Options</label>
                                <label style="display: flex; align-items: center; cursor: pointer; gap: 10px;">
                                    <input type="checkbox" id="exam-scramble" style="width: 18px; height: 18px;">
                                    <span>Scramble question order</span>
                                </label>
                                <p style="font-size: 0.8rem; color: var(--light-text); margin-top: 5px;">
                                    Each student gets questions in random order
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Questions -->
                <div class="form-section">
                    <div class="section-header section-header-questions">
                        <h3>Questions</h3>
                        <div class="actions">
                            <button type="button" id="media-upload-btn" class="btn btn-outline"
                                style="margin-right: 10px;" onclick="examManager.openMediaModal()">üì∑ Media</button>
                            <button type="button" id="bulk-import-btn" class="btn btn-secondary"
                                style="margin-right: 10px;" onclick="examManager.openImportModal()">Bulk
                                Import</button>
                            <button type="button" id="add-question-btn" class="btn btn-primary">+ Add Question</button>
                        </div>
                    </div>

                    <div class="empty-state" id="no-questions-msg" style="padding: 20px 0;">
                        <p>No questions added yet.</p>
                    </div>
                    <div id="questions-container">
                        <!-- Dynamic Questions will appear here -->
                    </div>
                </div>

                <!-- Step 3: Global Actions -->
                <div class="form-section form-actions"
                    style="text-align: right; background: transparent; border: none; padding: 0;">
                    <button type="button" class="btn btn-cancel" onclick="window.history.back()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Publish Exam</button>
                </div>
            </form>
        </main>
    </div>

    <!-- Bulk Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bulk Import Questions</h3>
                <span class="close-btn" onclick="examManager.closeImportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px; font-size: 0.9rem; color: var(--light-text);">
                    Paste your questions below. Separate questions with a blank line.<br>
                    Format:<br>
                    1. Question text...<br>
                    (a) Option A<br>
                    (b) Option B...
                </p>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="import-points" style="font-weight: 600;">Points per Question (Objective Only)</label>
                    <input type="number" id="import-points" class="form-control" value="0.5" min="0" step="0.5"
                        style="width: 100px;">
                    <p style="font-size: 0.8rem; color: var(--light-text); margin-top: 5px;">
                        Applies to objective questions only. Theory questions will automatically get 0 points.
                    </p>
                </div>
                <textarea id="import-text" class="form-control" rows="12"
                    placeholder="Paste questions here..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="examManager.closeImportModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="examManager.processBulkImport()">Import</button>
            </div>
        </div>
    </div>

    <!-- Media Upload Modal -->
    <div id="media-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üì∑ Upload Media (Images, Diagrams, Shapes)</h3>
                <span class="close-btn" onclick="examManager.closeMediaModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; font-size: 0.9rem; color: var(--light-text);">
                    Upload images, diagrams, or shapes here. After uploading, you can assign each media to a specific
                    question.
                </p>

                <!-- Upload Area -->
                <div id="media-upload-area"
                    style="border: 2px dashed var(--border-color); border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 20px; background: var(--inner-bg); transition: all 0.3s ease; cursor: pointer;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üìÅ</div>
                    <p style="font-weight: 600; margin-bottom: 5px;">Drop images here or click to upload</p>
                    <p style="font-size: 0.85rem; color: var(--light-text);">Supports: PNG, JPG, GIF, SVG, WebP</p>
                    <input type="file" id="media-file-input" multiple accept="image/*" style="display: none;">
                </div>

                <!-- Paste from clipboard notice -->
                <div
                    style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; border-left: 4px solid var(--primary-color);">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong>üí° Tip:</strong> You can also <strong>paste images directly</strong> from your clipboard
                        (Ctrl+V / Cmd+V) while this modal is open!
                    </p>
                </div>

                <!-- Uploaded Media Gallery -->
                <div id="uploaded-media-container" style="display: none;">
                    <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>Uploaded Media</span>
                        <span id="media-count"
                            style="background: var(--primary-color); color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.8rem;">0</span>
                    </h4>
                    <div id="media-gallery"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; max-height: 350px; overflow-y: auto; padding: 5px;">
                        <!-- Media items will be added here dynamically -->
                    </div>
                </div>

                <!-- No media message -->
                <div id="no-media-msg" style="text-align: center; padding: 20px; color: var(--light-text);">
                    <p>No media uploaded yet. Upload some images to get started.</p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <span id="media-assignment-status" style="font-size: 0.85rem; color: var(--light-text);"></span>
                <div>
                    <button type="button" class="btn" onclick="examManager.closeMediaModal()">Done</button>
                </div>
            </div>
        </div>
    </div>

    <template id="question-template">
        <div class="question-item" data-id="{id}">
            <div class="question-header">
                <div>
                    <strong>Question <span class="q-number">{n}</span></strong>
                </div>
                <button type="button" class="btn" style="color: var(--accent-color); padding: 2px 8px;"
                    onclick="examManager.removeQuestion('{id}')">Remove</button>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
                <label
                    style="font-size: 0.85rem; color: var(--light-text); margin-bottom: 4px; display: block;">Question
                    Type</label>
                <select class="form-control q-type" onchange="examManager.changeQuestionType('{id}', this.value)"
                    style="padding: 8px 12px;">
                    <option value="mcq">Multiple Choice</option>
                    <option value="true_false">True / False</option>
                    <option value="fill_blank">Fill in the Blank</option>
                    <option value="match">Matching Pairs</option>
                    <option value="image_mcq">Image Question</option>
                    <option value="theory">Theory (Essay)</option>
                </select>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label
                    style="font-size: 0.85rem; color: var(--light-text); margin-bottom: 4px; display: block;">Question
                    Text</label>
                <textarea class="form-control q-text auto-expand" placeholder="Enter question text" required rows="2"
                    style="padding: 10px 12px;"></textarea>
            </div>
            <div class="q-options-container">
                <!-- Options injected here -->
            </div>
            <div class="form-group" style="margin-top: 10px;">
                <label>Points</label>
                <input type="number" class="form-control q-points" value="0.5" min="0" step="0.5" style="width: 80px;">
            </div>
        </div>
    </template>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabaseClient.js"></script>
    <!-- Configuration System -->
    <script type="module">
        import { initConfig } from '../config/index.js';
        // Initialize configuration before other scripts
        await initConfig();
    </script>


    <script src="../js/utils.js"></script>
    <script src="../js/dataService.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Set user name
        const user = dataService.getCurrentUser();
        if (user) {
            const desktop = document.getElementById('user-desktop-name');
            const mobile = document.getElementById('user-mobile-name');
            if (desktop) desktop.innerText = user.name;
            if (mobile) mobile.innerText = user.name;
        } else {
            // Redirect if no user? Or let it be for now
            if (window.location.protocol !== 'file:') window.location.href = '../index.html';
        }
    </script>
    <script>
        // Cascading dropdown logic for School Level -> Subject
        const subjectsByLevel = {
            secondary: [
                'Maths',
                'English (grammar)',
                'English (comprehension)',
                'English (composition)',
                'Civic education',
                'Literature',
                'Physics',
                'Chemistry',
                'Economics',
                'Biology',
                'Further Mathematics',
                'Yoruba',
                'CRS/IRS',
                'Agric Science',
                'Food and Nutrition',
                'Geography',
                'Government',
                'Data Processing',
                'Commerce',
                'Marketing',
                'Financial Accounting',
                'Basic Science',
                'Basic Technology',
                'Home Economics',
                'Business Studies',
                'French',
                'Culture and Creative Arts',
                'History',
                'Social Studies',
                'Music',
                'Speech',
                'ICT',
                'PHE'
            ],
            primary: [
                'Mathematics',
                'English Studies',
                'Home Economics',
                'Basic Science',
                'Agricultural Science',
                'National Value',
                'Verbal Reasoning',
                'Quantitative Reasoning',
                'C.R.S',
                'P.H.E',
                'Computer Studies',
                'History',
                'French',
                'Speech'
            ]
        };

        // Handle school level change
        document.addEventListener('DOMContentLoaded', () => {
            const schoolLevelSelect = document.getElementById('exam-school-level');
            const subjectSelect = document.getElementById('exam-subject');
            const subjectHint = document.getElementById('subject-hint');

            if (schoolLevelSelect && subjectSelect) {
                schoolLevelSelect.addEventListener('change', function () {
                    const selectedLevel = this.value;

                    // Clear current options
                    subjectSelect.innerHTML = '';

                    if (selectedLevel && subjectsByLevel[selectedLevel]) {
                        // Enable the subject dropdown
                        subjectSelect.disabled = false;
                        subjectHint.style.display = 'none';

                        // Add default option
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Select Subject';
                        subjectSelect.appendChild(defaultOption);

                        // Add subjects for the selected level
                        subjectsByLevel[selectedLevel].forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject;
                            option.textContent = subject;
                            subjectSelect.appendChild(option);
                        });
                    } else {
                        // Disable the subject dropdown if no level selected
                        subjectSelect.disabled = true;
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Select school level first';
                        subjectSelect.appendChild(defaultOption);
                        subjectHint.style.display = 'block';
                    }
                });
            }
        });
    </script>
    <script src="../js/examManager.js"></script>
</body>

</html>