<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="client-id" content="seatos">
    <title>Teacher Dashboard - CBT Exam</title>
    <link rel="manifest" href="../manifest.json">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        /* Updated Dashboard Styles */
        .dashboard-grid {
            display: flex;
            /* Changed from grid to flex */
            flex-wrap: wrap;
            justify-content: center;
            /* Center the cards */
            gap: 20px;
        }

        .stat-card {
            flex: 0 1 auto;
            /* Don't grow to fill */
            width: 250px;
            /* Fixed smaller width */
            background: transparent;
            /* Remove BG */
            background-color: transparent !important;
            /* Force override */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            /* Subtle border */
        }

        /* Dark Mode Modal Support */
        [data-theme="dark"] .modal-content {
            background-color: #2d3436;
            border-color: #444;
            color: #eee;
        }

        [data-theme="dark"] .close-btn {
            color: #aaa;
        }

        [data-theme="dark"] .stat-card {
            border-color: #444;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] textarea,
        [data-theme="dark"] input {
            background-color: #2d3436;
            border-color: #555;
            color: #fff;
        }

        /* Subtle button shadows in dark mode */
        [data-theme="dark"] .btn {
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), -2px -2px 4px rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .btn:active {
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.4), inset -2px -2px 4px rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .btn:active {
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.4), inset -2px -2px 4px rgba(255, 255, 255, 0.05);
        }

        /* Credentials Dropdown */
        .credentials-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .dropdown-btn:hover {
            background: var(--inner-bg);
            border-color: var(--primary-color);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 5px);
            background: var(--card-bg);
            min-width: 200px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 8px 0;
            z-index: 4000;
            border: 1px solid var(--border-color);
            animation: slideUp 0.2s ease-out;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background: var(--inner-bg);
            color: var(--primary-color);
        }

        .dropdown-item.danger {
            color: var(--accent-color);
        }

        .dropdown-item.danger:hover {
            background: #fff5f5;
        }

        [data-theme="dark"] .dropdown-item.danger:hover {
            background: #3a1c1c;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Logout Button */
        .btn-logout-mobile {
            padding: 6px 12px;
            font-size: 0.9rem;
            color: var(--text-color);
            background: transparent;
            border: 1px solid #ccc;
            /* Default border */
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        [data-theme="dark"] .btn-logout-mobile {
            border-color: #555;
        }

        .btn-logout-mobile:hover {
            background: var(--inner-bg);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* Flag item styling - ensure full question text visibility */
        .flag-item {
            background: var(--inner-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-color);
        }

        .flag-item div[style*="font-style"] {
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        /* Flag review body - ensure scrollable and visible */
        #flag-review-body {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Edit question textarea */
        #edit-q-text {
            min-height: 120px;
            resize: vertical;
            word-wrap: break-word;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="main-header">
            <div class="logo">
                <!-- Logo image will be injected here by themeApplier if available -->
                <div class="logo-text-group">
                    <h1 id="user-name"
                        style="font-family: 'Futura', 'Century Gothic', 'Arial Rounded MT Bold', sans-serif; font-size: 1.5rem; margin: 0; font-weight: 700;">
                        Teacher</h1>
                    <p id="app-subtitle" style="font-size: 0.75rem; margin: 0; opacity: 0.7; font-weight: 400;"><span
                            class="desktop-text">Teacher Dashboard</span><span class="mobile-text">TD</span></p>
                </div>
            </div>
            <div class="user-menu desktop-only" style="display: flex; align-items: center; gap: 15px;">
                <!-- School ID Input -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="teacher-school-id" style="font-size: 0.85rem; color: var(--light-text);">School
                        ID:</label>
                    <input type="text" id="teacher-school-id" placeholder="Enter school ID"
                        style="padding: 5px 10px; font-size: 0.85rem; border: 1px solid var(--border-color); border-radius: 4px; width: 120px; background: var(--card-bg); color: var(--text-color);">
                    <button onclick="saveTeacherSchoolId()" class="btn"
                        style="padding: 5px 10px; font-size: 0.8rem; background: var(--accent-color); color: white; border: none;">Save</button>
                </div>
                <!-- Messages Notification Bell -->
                <button id="messages-bell" onclick="openMessagesSection()"
                    style="position: relative; background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px;"
                    title="Messages from Admin">
                    üîî
                    <span id="messages-badge" style="
                        display: none;
                        position: absolute;
                        top: 0;
                        right: 0;
                        background: #e74c3c;
                        color: white;
                        font-size: 0.7rem;
                        font-weight: bold;
                        min-width: 18px;
                        height: 18px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">0</span>
                </button>
                <!-- Dark mode toggle will be injected here by utils.js -->
                <div class="credentials-dropdown">
                    <button id="credentials-btn" class="dropdown-btn" onclick="toggleCredentialsDropdown()">
                        <span id="nav-user-display"
                            style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">üë§
                            Account</span>
                        <span style="font-size: 0.8rem; opacity: 0.6;">‚ñº</span>
                    </button>
                    <div id="credentials-dropdown-content" class="dropdown-content">
                        <div
                            style="padding: 10px 16px; font-size: 0.75rem; color: var(--light-text); text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px;">
                            Settings</div>
                        <button class="dropdown-item" onclick="openChangeUsernameModal()">
                            <span>üÜî Change Username</span>
                        </button>
                        <button class="dropdown-item" onclick="openChangePasswordModal()">
                            <span>üîë Change Password</span>
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item danger" onclick="auth.logout()">
                            <span>üö™ Logout</span>
                        </button>
                    </div>
                </div>
            </div>
            <button id="mobile-menu-btn" class="hamburger-btn">‚ò∞</button>
        </header>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="mobile-menu">
            <div class="mobile-menu-content">
                <div class="mobile-user-row">
                    <div id="mobile-user-name" style="font-weight: bold; font-size: 1.1rem; color: var(--text-color);">
                        Teacher Dashboard</div>
                    <button id="mobile-theme-toggle" class="btn"
                        style="background: transparent; font-size: 1.2rem;">üåì</button>
                </div>

                <div class="mobile-actions"
                    style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-outline" onclick="openChangeUsernameModal()"
                        style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 12px;">
                        <span>üÜî Change Username</span>
                    </button>
                    <button class="btn btn-outline" onclick="openChangePasswordModal()"
                        style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 12px;">
                        <span>üîë Change Password</span>
                    </button>
                    <button class="btn danger" onclick="auth.logout()"
                        style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 12px; margin-top: 10px;">
                        <span>üö™ Logout</span>
                    </button>
                </div>

                <div class="mobile-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="mobile-total-exams">0</div>
                        <div class="stat-label">Total Exams</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="openFlagReviewModalFromMobile()">
                        <div class="stat-number" id="mobile-results-pending-count">-</div>
                        <div class="stat-label">Results Pending / Flags</div>
                    </div>
                </div>

                <!-- Mobile School ID Input -->
                <div style="margin: 15px 0; padding: 10px; background: var(--inner-bg); border-radius: 8px;">
                    <label
                        style="font-size: 0.85rem; color: var(--light-text); margin-bottom: 5px; display: block;">School
                        ID</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="mobile-teacher-school-id" placeholder="Enter school ID"
                            style="flex: 1; padding: 8px 10px; font-size: 0.9rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-color);">
                        <button onclick="saveTeacherSchoolId(true)" class="btn btn-primary"
                            style="padding: 8px 15px; font-size: 0.85rem;">Save</button>
                    </div>
                    <small style="color: var(--light-text); font-size: 0.75rem; margin-top: 5px; display: block;">Get
                        this from your admin</small>
                </div>

                <!-- Mobile Messages Button -->
                <button class="btn"
                    onclick="openMessagesSection(); document.getElementById('mobile-menu').classList.remove('show');"
                    style="width: 100%; margin-bottom: 10px; background: var(--card-bg); border: 1px solid var(--border-color); position: relative; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    üîî Messages from Admin
                    <span id="mobile-messages-badge" style="
                            display: none;
                            background: #e74c3c;
                            color: white;
                            font-size: 0.75rem;
                            font-weight: bold;
                            min-width: 20px;
                            height: 20px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">0</span>
                </button>

                <button class="btn btn-primary"
                    style="width: 100%; margin-bottom: 10px; background-color: #2ecc71; border-color: #2ecc71;"
                    onclick="prepareDevice()">üíæ Prepare Device for Offline</button>
            </div>
        </div>

        <main class="main-content" style="display: block;">
            <div class="section-header desktop-only">
                <button class="btn btn-primary" style="background-color: #2ecc71; border-color: #2ecc71; color: white;"
                    onclick="prepareDevice()">üíæ Prepare Device for Offline</button>
                <div style="display: flex; gap: 10px;">
                    <a href="create-exam.html" class="btn btn-primary">+ Create New Exam</a>
                </div>
            </div>

            <!-- Admin Messages Section -->
            <div id="messages-section" style="display: none; margin-bottom: 20px;">
                <div class="section-header" style="cursor: pointer;" onclick="toggleMessagesSection()">
                    <h3 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        üì¨ Messages from Admin
                        <span id="unread-count"
                            style="background: #e74c3c; color: white; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px;">0</span>
                    </h3>
                    <span id="messages-toggle-icon" style="font-size: 1.2rem;">‚ñº</span>
                </div>
                <div id="messages-container"
                    style="background: var(--card-bg); border-radius: 10px; padding: 15px; border: 1px solid var(--border-color);">
                    <!-- Messages will be loaded here -->
                    <p style="color: var(--light-text); text-align: center;">Loading messages...</p>
                </div>
            </div>

            <!-- Stats Row (Desktop Only) -->
            <div class="dashboard-grid desktop-only">
                <div class="stat-card">
                    <div class="stat-number" id="total-exams">0</div>
                    <div class="stat-label">Total Exams</div>
                </div>
                <!-- Future stats -->
                <div class="stat-card" style="cursor: pointer;" onclick="openFlagReviewModal()">
                    <div class="stat-number" id="results-pending-count">-</div>
                    <div class="stat-label">Results Pending / Flags</div>
                </div>
            </div>

            <!-- My Exams Section Header -->
            <div class="section-header">
                <h3 class="section-title">My Exams</h3>
                <!-- Mobile: Show Create button here -->
                <div class="mobile-only">
                    <a href="create-exam.html" class="btn btn-primary">+ Create New Exam</a>
                </div>
            </div>

            <!-- Exams Grid -->
            <div id="exams-grid" class="exam-grid">
                <!-- Javascript will populate this -->
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <p>No exams found. Create your first exam to get started.</p>
                </div>
            </div>

            <!-- Archived Exams Section -->
            <div id="archived-section" style="margin-top: 30px; display: none;">
                <div class="section-header" style="cursor: pointer;" onclick="toggleArchivedSection()">
                    <h3 class="section-title">
                        <span id="archive-toggle-icon">‚ñ∂</span>
                        Archived Exams
                        <span id="archived-count" style="font-size: 0.9rem; color: var(--light-text);">(0)</span>
                    </h3>
                </div>
                <div id="archived-grid" class="exam-grid" style="display: none;">
                    <!-- Archived exams will be populated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Extensions Modal -->
    <div id="extensions-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 3000;">
        <div class="modal-content"
            style="background: var(--card-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; z-index: 3001;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                <h3 style="margin: 0;">Manage Time Extensions</h3>
                <span class="close-btn" onclick="closeExtensionsModal()"
                    style="cursor: pointer; font-size: 1.5rem; color: var(--light-text);">&times;</span>
            </div>
            <p id="ext-exam-title" style="margin-bottom: 15px; color: var(--light-text);"></p>

            <div class="form-group">
                <label>Select Student</label>
                <select id="ext-student-select" class="form-control">
                    <option value="">Loading students...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Extra Time (Minutes)</label>
                <input type="number" id="ext-minutes" class="form-control" placeholder="e.g. 15" min="1">
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveExtension()">Grant Extension</button>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">

            <h4>Current Extensions</h4>
            <div id="ext-list" style="margin-top: 10px;">
                <!-- List items -->
            </div>
        </div>
    </div>

    <!-- Flag Review Modal -->
    <div id="flag-review-modal" class="modal">
        <div class="modal-content"
            style="max-width: 800px; height: 100vh; display: flex; flex-direction: column; resize: both; overflow: auto; margin: 0; max-height: none; border-radius: 0;">
            <div class="modal-header">
                <h3>Review Flagged Questions</h3>
                <span class="close-btn" onclick="closeFlagReviewModal()">&times;</span>
            </div>
            <div id="flag-review-body" style="overflow-y: auto; flex: 1; padding-right: 10px;">
                <!-- Content injected by JS -->
                <p>Loading flags...</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeFlagReviewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Question Modal (Mini) -->
    <div id="edit-question-modal" class="modal" style="z-index: 2200;">
        <div class="modal-content"
            style="max-width: 600px; height: 100vh; display: flex; flex-direction: column; resize: both; overflow: auto; margin: 0; max-height: none; border-radius: 0;">
            <div style="padding: 20px; display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <h3>Edit Question & Options</h3>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Update the question text and answer
                    options below.</p>

                <div style="flex: 1; overflow-y: auto; padding-right: 10px;">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label>Question Type</label>
                        <select id="edit-q-type" class="form-control">
                            <option value="mcq">Multiple Choice</option>
                            <option value="true_false">True / False</option>
                            <option value="fill_blank">Fill in the Blank</option>
                            <option value="match">Matching Pairs</option>
                            <option value="image_mcq">Image Question</option>
                            <option value="image_multi">Picture Comprehension</option>
                            <option value="theory">Theory (Essay)</option>
                        </select>
                    </div>

                    <div id="edit-q-media-container" style="margin-bottom: 15px; display: none;">
                        <!-- Media preview placeholder -->
                    </div>

                    <div class="form-group">
                        <label>Question Text</label>
                        <textarea id="edit-q-text" class="form-control" rows="3"></textarea>
                    </div>

                    <label style="margin-top: 10px; display: block; font-weight: bold;">Answer Options</label>
                    <div id="edit-q-options-container"
                        style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                        <!-- Options injected by JS -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addEditOption()"
                        style="margin-top: 10px; padding: 6px 15px; font-size: 0.9rem;">
                        + Add Option
                    </button>
                </div>

                <input type="hidden" id="edit-q-exam-id">
                <input type="hidden" id="edit-q-index">

                <div class="model-footer"
                    style="padding-top: 15px; text-align: right; border-top: 1px solid #eee; margin-top: auto;">
                    <button class="btn btn-outline"
                        onclick="document.getElementById('edit-question-modal').style.display='none'">Cancel</button>
                    <button class="btn btn-primary" onclick="saveQuestionEdit()">Save & Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Message Modal -->
    <div id="message-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 2000;">
        <div class="modal-content"
            style="background: var(--card-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="msg-title" style="margin: 0; font-size: 1.2rem;">Title</h3>
                <span style="cursor: pointer; font-size: 1.5rem; line-height: 1;"
                    onclick="closeMessageModal()">&times;</span>
            </div>
            <div id="msg-body" style="margin-bottom: 25px; line-height: 1.5; color: var(--text-color);">
                Message body...
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="msg-cancel-btn" class="btn btn-outline" onclick="closeMessageModal()">Close</button>
                <button id="msg-confirm-btn" class="btn btn-primary" style="display: none;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal" style="display: none; z-index: 3000;">
        <div class="modal-content" style="max-width: 400px; margin: 5vh auto; width: 92%;">
            <div class="modal-header">
                <h3>üîë Change Password</h3>
                <span class="close-btn" onclick="closeChangePasswordModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p style="font-size: 0.9rem; color: var(--light-text); margin-bottom: 20px;">
                    Enter your current password and a new secure password.
                </p>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label
                        style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 5px;">Current
                        Password</label>
                    <div class="password-input-container" style="position: relative;">
                        <input type="password" id="current-password" class="form-control"
                            autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            style="width: 100%; padding-right: 40px;">
                        <button type="button" class="password-toggle-btn"
                            onclick="togglePasswordVisibility('current-password', this)"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">üëÅÔ∏è</button>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 5px;">New
                        Password</label>
                    <div class="password-input-container" style="position: relative;">
                        <input type="password" id="new-password" class="form-control" autocomplete="new-password"
                            placeholder="At least 8 characters" style="width: 100%; padding-right: 40px;">
                        <button type="button" class="password-toggle-btn"
                            onclick="togglePasswordVisibility('new-password', this)"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">üëÅÔ∏è</button>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label
                        style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 5px;">Confirm
                        New Password</label>
                    <input type="password" id="confirm-new-password" class="form-control" autocomplete="new-password"
                        placeholder="Repeat new password" style="width: 100%;">
                </div>

                <div id="password-error" style="color: #e74c3c; font-size: 0.85rem; margin-top: 10px; display: none;">
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-outline" onclick="closeChangePasswordModal()">Cancel</button>
                <button id="submit-password-btn" class="btn btn-primary" onclick="submitPasswordChange()">Update
                    Password</button>
            </div>
        </div>
    </div>

    <!-- Change Username Modal -->
    <div id="change-username-modal" class="modal" style="display: none; z-index: 3000;">
        <div class="modal-content" style="max-width: 400px; margin: 10vh auto; width: 92%;">
            <div class="modal-header">
                <h3>üÜî Change Username</h3>
                <span class="close-btn" onclick="closeChangeUsernameModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p style="font-size: 0.9rem; color: var(--light-text); margin-bottom: 20px;">
                    Update your account identifier (username).
                </p>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 5px;">New
                        Username</label>
                    <input type="text" id="new-username" class="form-control" placeholder="e.g. mrs.smith"
                        style="width: 100%;">
                </div>


                <div id="username-error" style="color: #e74c3c; font-size: 0.85rem; margin-top: 10px; display: none;">
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-outline" onclick="closeChangeUsernameModal()">Cancel</button>
                <button id="submit-username-btn" class="btn btn-primary" onclick="submitUsernameChange()">Update
                    Username</button>
            </div>
        </div>
    </div>

    <!-- Secret Delete Exam Modal -->
    <div id="delete-exam-modal" class="modal" style="display: none; z-index: 3000;">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <div class="modal-header" style="border-bottom: none; justify-content: center;">
                <h3 style="color: #e74c3c;">‚ö†Ô∏è Delete Exam Permanently</h3>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 15px; color: var(--light-text);">
                    You are about to <strong style="color: #e74c3c;">permanently delete</strong> the exam:
                </p>
                <p id="delete-exam-title"
                    style="font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; color: var(--text-color);"></p>
                <p style="margin-bottom: 10px; font-size: 0.9rem; color: var(--light-text);">
                    This action <strong>cannot be undone</strong>. All associated student results will also be lost.
                </p>
                <div class="form-group" style="margin-top: 20px; text-align: left;">
                    <label style="font-size: 0.85rem; color: var(--light-text);">Type the exam title to confirm:</label>
                    <input type="text" id="delete-confirm-input" class="form-control"
                        placeholder="Type exam title here..." autocomplete="off">
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; padding: 10px 20px 20px;">
                <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
                <button id="delete-confirm-btn" class="btn"
                    style="background: #e74c3c; color: white; opacity: 0.5; cursor: not-allowed;" disabled
                    onclick="confirmDeleteExam()">üóëÔ∏è Delete Forever</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- PocketBase SDK -->
    <script src="https://unpkg.com/pocketbase@0.21.0/dist/pocketbase.umd.js"></script>
    <!-- Configuration System -->
    <script type="module">
        import { initConfig } from '../config/index.js';
        // Initialize configuration before other scripts
        await initConfig();
    </script>


    <script src="../js/idb.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/dataService.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Global Flag Helper
        window.countActiveFlags = function (flagsObj) {
            if (!flagsObj) return 0;
            return Object.values(flagsObj).filter(v => {
                // Strict check for boolean true or string "true", handling objects safely
                if (typeof v === 'object') return false; // Objects (like resolved status) are not active flags
                return v === true || String(v).toLowerCase() === 'true';
            }).length;
        };

        // Save Teacher School ID
        window.saveTeacherSchoolId = async function (isMobile = false) {
            const inputId = isMobile ? 'mobile-teacher-school-id' : 'teacher-school-id';
            const input = document.getElementById(inputId);
            const schoolId = input ? input.value.trim() : '';

            if (!schoolId) {
                Utils.showAlert('Missing Info', 'Please enter a School ID');
                return;
            }

            try {
                // Show loading state
                const btn = isMobile ?
                    document.querySelector('.mobile-actions button[onclick^="saveTeacherSchoolId"]') :
                    document.querySelector('.user-menu button[onclick^="saveTeacherSchoolId"]');

                const originalText = btn ? btn.textContent : 'Save';
                if (btn) btn.textContent = '‚è≥ ...';

                await dataService.updateProfile({ schoolVersion: schoolId });

                // Sync both inputs
                const desktopInput = document.getElementById('teacher-school-id');
                const mobileInput = document.getElementById('mobile-teacher-school-id');
                if (desktopInput) desktopInput.value = schoolId;
                if (mobileInput) mobileInput.value = schoolId;

                Utils.showToast('School ID saved and shared with Admin!', 'success');

                if (btn) btn.textContent = originalText;

            } catch (err) {
                console.error('Error saving school ID:', err);
                await Utils.showAlert('Error', 'Failed to save: ' + err.message);
            }
        };


        // Admin Messages Functions
        let messagesExpanded = true;

        async function loadAdminMessages(teacherId) {
            const section = document.getElementById('messages-section');
            const container = document.getElementById('messages-container');
            const unreadBadge = document.getElementById('unread-count');
            const bellBadge = document.getElementById('messages-badge');
            const mobileBadge = document.getElementById('mobile-messages-badge');

            // Hide section by default - only show if there are messages
            // section.style.display = 'none'; // Keep section state if already loaded

            try {
                // Fetch messages sent to this teacher
                const messages = await dataService.getMessages({ toId: teacherId });
                console.log('Loaded messages for teacher:', teacherId, messages);

                if (messages && messages.length > 0) {
                    // Show the section only if there are messages
                    section.style.display = 'block';

                    // Count unread
                    const unreadCount = messages.filter(m => !m.read).length;

                    // Update section badge
                    unreadBadge.textContent = unreadCount;
                    unreadBadge.style.display = unreadCount > 0 ? 'inline' : 'none';

                    // Update navbar bell badge
                    if (bellBadge) {
                        bellBadge.textContent = unreadCount;
                        bellBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
                    }
                    // Update mobile badge
                    if (mobileBadge) {
                        mobileBadge.textContent = unreadCount;
                        mobileBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
                    }

                    // Render messages
                    container.innerHTML = messages.map(msg => {
                        const date = new Date(msg.created_at);
                        const formattedDate = date.toLocaleDateString('en-US', {
                            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        const isUnread = !msg.read;

                        return `
                            <div class="message-card" id="message-${msg.id}" style="
                                background: ${isUnread ? 'var(--inner-bg)' : 'var(--card-bg)'}; 
                                padding: 15px; 
                                border-radius: 8px; 
                                margin-bottom: 10px; 
                                border-left: 4px solid ${isUnread ? '#e74c3c' : '#27ae60'};
                                border: 1px solid var(--border-color);
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: var(--text-color);">
                                        ${isUnread ? 'üî¥ New' : '‚úÖ Read'} - From: ${msg.expand?.from_id?.full_name || 'Admin'}
                                    </span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 0.85rem; color: var(--light-text);">${formattedDate}</span>
                                        <button onclick="deleteMessage('${msg.id}')" 
                                            style="background: transparent; border: none; cursor: pointer; font-size: 1rem; opacity: 0.6; padding: 2px 5px;"
                                            title="Delete message">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <p style="margin: 0; color: var(--text-color); line-height: 1.5;">${msg.message}</p>
                                <div style="margin-top: 10px; display: flex; gap: 10px;">
                                    ${isUnread ? `<button onclick="markMessageRead('${msg.id}')" class="btn" style="font-size: 0.8rem; padding: 5px 10px; background: var(--primary-color); color: white; border: none; border-radius: 4px;">‚úì Mark as Read</button>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // No messages
                    section.style.display = 'none'; // Keep section hidden by default
                    if (unreadBadge) unreadBadge.style.display = 'none';
                    if (bellBadge) bellBadge.style.display = 'none';
                    if (mobileBadge) mobileBadge.style.display = 'none';

                    // IMPORTANT: Update container so if user opens it manually (via bell), they see "No messages" instead of "Loading..."
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--light-text);">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üì≠</div>
                            <p>No messages from admin</p>
                        </div>
                    `;

                    section.style.display = 'none';
                    unreadBadge.style.display = 'none';
                    if (bellBadge) bellBadge.style.display = 'none';
                    if (mobileBadge) mobileBadge.style.display = 'none';
                }

                // Setup real-time messaging
                setupMessageSubscription(teacherId);

            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--light-text);">
                        <div style="font-size: 2rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <p>Could not load messages</p>
                        <small style="opacity: 0.7;">${error.message || 'Database not available'}</small>
                    </div>
                `;
            }
        }

        let isMessageSubscribed = false;
        async function setupMessageSubscription(teacherId) {
            if (isMessageSubscribed) return;

            try {
                await dataService.subscribeToMessages(async (e) => {
                    if (e.action === 'create' && e.record.to_id === teacherId) {
                        console.log('üì¨ New message received real-time!');
                        await loadAdminMessages(teacherId);

                        // Small alert for new message
                        const toast = document.createElement('div');
                        toast.textContent = 'üì© New message from Admin!';
                        toast.style.cssText = 'position: fixed; bottom: 80px; left: 20px; background: #e67e22; color: white; padding: 12px 20px; border-radius: 8px; z-index: 9999; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s;';
                        document.body.appendChild(toast);
                        setTimeout(() => {
                            toast.style.opacity = '0';
                            toast.style.transition = 'opacity 0.3s';
                            setTimeout(() => toast.remove(), 300);
                        }, 3000);
                    }
                });
                isMessageSubscribed = true;
            } catch (err) {
                console.warn('Message subscription failed:', err);
            }
        }


        // Function to open messages section when bell is clicked
        window.openMessagesSection = function () {
            const section = document.getElementById('messages-section');
            const container = document.getElementById('messages-container');
            const icon = document.getElementById('messages-toggle-icon');

            // Ensure section is visible
            section.style.display = 'block';

            // Expand messages container
            messagesExpanded = true;
            container.style.display = 'block';
            if (icon) icon.textContent = '‚ñº';

            // Scroll to messages section
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.toggleMessagesSection = function () {
            const container = document.getElementById('messages-container');
            const icon = document.getElementById('messages-toggle-icon');
            messagesExpanded = !messagesExpanded;
            container.style.display = messagesExpanded ? 'block' : 'none';
            icon.textContent = messagesExpanded ? '‚ñº' : '‚ñ∂';
        };

        window.markMessageRead = async function (messageId) {
            try {
                await dataService.markMessageAsRead(messageId);
                // Refresh messages
                const user = dataService.getCurrentUser();
                if (user) {
                    await loadAdminMessages(user.profileId || user.id);
                }
            } catch (error) {
                console.error('Error marking message as read:', error);
            }
        };

        window.deleteMessage = async function (messageId) {
            if (!(await Utils.showConfirm('Delete Message', 'Are you sure you want to delete this message?'))) {
                return;
            }

            try {
                await dataService.deleteMessage(messageId);
                // Remove from DOM immediately for snappy UI
                const msgElement = document.getElementById(`message-${messageId}`);
                if (msgElement) {
                    msgElement.style.opacity = '0';
                    msgElement.style.transition = 'opacity 0.3s';
                    setTimeout(() => msgElement.remove(), 300);
                }
                // Refresh to update counters
                const user = dataService.getCurrentUser();
                if (user) {
                    setTimeout(() => loadAdminMessages(user.profileId || user.id), 400);
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                await Utils.showAlert('Error', 'Failed to delete message: ' + error.message);
            }
        };


        // Connection Monitoring
        function setupConnectionMonitoring() {
            const updateStatus = () => {
                const isOnline = navigator.onLine;
                let el = document.getElementById('connection-status');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'connection-status';
                    el.style.position = 'fixed';
                    el.style.top = '10px';
                    el.style.right = '120px';
                    el.style.zIndex = '2000';
                    el.style.padding = '5px 10px';
                    el.style.borderRadius = '20px';
                    el.style.fontSize = '0.8rem';
                    el.style.fontWeight = 'bold';
                    document.body.appendChild(el);
                }

                if (isOnline) {
                    el.textContent = 'üü¢ Online';
                    el.style.backgroundColor = '#d4edda';
                    el.style.color = '#155724';
                    el.style.border = '1px solid #c3e6cb';
                    setTimeout(() => { if (el) el.style.opacity = '0'; }, 5000);
                    el.style.opacity = '1';
                } else {
                    el.textContent = 'üî¥ Offline';
                    el.style.backgroundColor = '#f8d7da';
                    el.style.color = '#721c24';
                    el.style.border = '1px solid #f5c6cb';
                    el.style.opacity = '1';
                }
            };

            window.addEventListener('online', () => {
                updateStatus();
                syncResults();
            });
            window.addEventListener('offline', updateStatus);

            updateStatus();
            if (navigator.onLine) setTimeout(syncResults, 2000);
        }

        async function syncResults() {
            const { synced, pending } = await dataService.syncPendingResults();
            if (synced > 0) {
                const el = document.getElementById('connection-status');
                if (el) {
                    el.textContent = `Syncing... (${synced} sent)`;
                    el.style.backgroundColor = '#ffeeba';
                    el.style.color = '#856404';
                    el.style.opacity = '1';
                    setTimeout(() => {
                        el.textContent = 'üü¢ Synced';
                        el.style.backgroundColor = '#d4edda';
                        el.style.color = '#155724';
                        // Refresh data?
                        location.reload();
                    }, 1500);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            setupConnectionMonitoring();
            // Auth Check
            const user = dataService.getCurrentUser();
            if (!user || user.role !== 'teacher') {
                window.location.href = '../index.html';
                return;
            }
            document.getElementById('user-name').textContent = user.name;

            // Resolving Teacher ID (Profile ID vs User ID)
            // Admin sends to Profile ID, so we must prefer that.
            let teacherId = user.profileId;

            if (!teacherId) {
                try {
                    // Try to fetch profile if not in local metadata
                    const profile = await dataService.pb.collection('profiles').getFirstListItem(`user="${user.id}"`);
                    if (profile) {
                        teacherId = profile.id;
                        // Optional: Update local user meta to avoid future lookups
                        user.profileId = profile.id;
                        localStorage.setItem('cbt_user_meta', JSON.stringify(user));
                        console.log('‚úÖ Resolved missing profile ID:', teacherId);
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è Could not resolve profile ID, falling back to User ID:', user.id);
                    teacherId = user.id;
                }
            }

            // Set app subtitle from config (if available)
            const appSubtitle = document.getElementById('app-subtitle');
            if (appSubtitle && window.configLoader) {
                const config = window.configLoader.getConfig();
                if (config.appName) {
                    appSubtitle.innerHTML = `<span class="desktop-text">${config.appName} TD</span><span class="mobile-text">TD</span>`;
                }
            }

            // Initialize Components
            // Initialize Components
            // renderExtensionsList expects arguments (exam, results), so we shouldn't call it blindly on init
            // It will be called when opening the modal or loading data
            if (window.loadAndRenderFlags) window.loadAndRenderFlags();


            // Load Admin Messages (Important: Uses User ID for database relations)
            await loadAdminMessages(user.id);

            // Load Data using Cache-First Strategy
            await loadDashboardData();



            // Mobile Menu
            const mName = document.getElementById('mobile-user-name');
            if (mName) mName.textContent = user.name;

            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');
            if (btn) btn.onclick = () => {
                menu.classList.toggle('show');
                btn.textContent = menu.classList.contains('show') ? '‚úï' : '‚ò∞';
            };

            // Mobile Theme Toggle
            const mThemeBtn = document.getElementById('mobile-theme-toggle');
            if (mThemeBtn) {
                const currentTheme = localStorage.getItem('theme') || 'light';
                mThemeBtn.innerHTML = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                mThemeBtn.onclick = () => {
                    const curr = document.documentElement.getAttribute('data-theme');
                    const next = curr === 'dark' ? 'light' : 'dark';
                    document.documentElement.setAttribute('data-theme', next);
                    localStorage.setItem('theme', next);
                    mThemeBtn.innerHTML = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';

                    // Update desktop toggle if it exists (Utils.js created it)
                    const dToggle = document.getElementById('theme-toggle');
                    if (dToggle) dToggle.innerHTML = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                };
            }

            // School ID Input Setup
            const schoolIdInput = document.getElementById('teacher-school-id');
            const mobileSchoolIdInput = document.getElementById('mobile-teacher-school-id');

            // Pre-fill from user's saved school_version
            if (user.schoolVersion) {
                if (schoolIdInput) schoolIdInput.value = user.schoolVersion;
                if (mobileSchoolIdInput) mobileSchoolIdInput.value = user.schoolVersion;
            }

            // Sync between desktop and mobile inputs
            if (schoolIdInput) {
                schoolIdInput.addEventListener('input', () => {
                    if (mobileSchoolIdInput) mobileSchoolIdInput.value = schoolIdInput.value;
                });
            }
            if (mobileSchoolIdInput) {
                mobileSchoolIdInput.addEventListener('input', () => {
                    if (schoolIdInput) schoolIdInput.value = mobileSchoolIdInput.value;
                });
            }

            // Load Admin Messages
            await loadAdminMessages(teacherId);

            // Load Data using Cache-First Strategy
            await loadDashboardData();


            // Initialize Secret Delete
            if (window.initSecretDelete) window.initSecretDelete();

            /* Old Logic Disabled
            try {
                // Fetch Exams and Results (for stats) in parallel
                // We use getResults to aggregate flags.
                const [exams, allResults] = await Promise.all([
                    dataService.getExams({ teacherId: user.id }),
                    dataService.getResults() // Get all results
                ]);

                // Calculate Flag Counts per Exam
                const examStats = {};
                allResults.forEach(r => {
                    if (!examStats[r.examId]) examStats[r.examId] = { flags: 0 };

                    if (r.flags) {
                        // Count only ACTIVE flags (true or "true")
                        // Exclude resolved flags (objects with status='resolved')
                        examStats[r.examId].flags += window.countActiveFlags(r.flags);
                    }
                });

                // Update Stats - Initial count before filtering
                // (Will be updated below with active exams only)

                // Calculate Pending Results (Global Red Count - Total Flagged Submissions / Students)
                // Filter for any ACTIVE flags
                const pendingCount = allResults.filter(r => window.countActiveFlags(r.flags) > 0).length;

                const pEl = document.getElementById('results-pending-count');
                if (pEl) pEl.textContent = pendingCount;

                const mpEl = document.getElementById('mobile-results-pending-count');
                if (mpEl) mpEl.textContent = pendingCount;

                // Render Grid
                const grid = document.getElementById('exams-grid');
                const archivedGrid = document.getElementById('archived-grid');
                const archivedSection = document.getElementById('archived-section');
                const archivedCountEl = document.getElementById('archived-count');

                // Separate active and archived exams
                const activeExams = exams.filter(e => e.status !== 'archived');
                const archivedExams = exams.filter(e => e.status === 'archived');

                // Update total exams count (only active)
                document.getElementById('total-exams').textContent = activeExams.length;
                const mobileStats = document.getElementById('mobile-total-exams');
                if (mobileStats) mobileStats.textContent = activeExams.length;

                // Helper function to render exam card
                const renderExamCard = (exam, isArchived = false) => {
                    const flagsCount = (examStats[exam.id] && examStats[exam.id].flags) || 0;
                    const examResults = allResults.filter(r => r.examId === exam.id);
                    const greenCount = examResults.filter(r => r.status === 'completed' && window.countActiveFlags(r.flags) === 0).length;
                    const yellowCount = examResults.filter(r => r.status === 'in-progress').length;
                    const redCount = examResults.reduce((sum, r) => sum + window.countActiveFlags(r.flags), 0);

                    // Format scheduled date if exists
                    let scheduleInfo = '';
                    if (exam.scheduledDate) {
                        const schedDate = new Date(exam.scheduledDate);
                        const now = new Date();
                        const isPast = schedDate < now;
                        const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                        scheduleInfo = `<span style="color: ${isPast ? 'var(--success-color)' : 'var(--accent-color)'}; font-size: 0.85rem;">üìÖ ${schedDate.toLocaleDateString('en-US', options)}${isPast ? ' ‚úì' : ''}</span>`;
                    }

                    const scrambleIndicator = exam.scrambleQuestions
                        ? '<span title="Questions scrambled" style="font-size: 0.85rem;">üîÄ</span>'
                        : '';

                    return `
                    <div class="exam-card" data-exam-id="${exam.id}" data-exam-title="${exam.title}" data-archived="${isArchived}" ${isArchived ? 'style="opacity: 0.7;"' : ''}>
                        <div class="exam-card-header">
                            <span class="exam-subject">${exam.subject || 'General'}</span>
                            <div class="exam-card-icons">
                                ${scrambleIndicator}
                                <span title="Completed" style="font-size: 0.9rem;">üü¢ ${greenCount}</span>
                                <span title="In Progress" style="font-size: 0.9rem;">üü° ${yellowCount}</span>
                                <span title="Flagged - Click to review" style="font-size: 0.9rem; cursor: pointer;" onclick="event.stopPropagation(); openFlagReviewModalForExam('${exam.id}')">üî¥ ${redCount}</span>
                            </div>
                        </div>
                        <div class="exam-card-body">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; overflow: hidden;">
                                <h4 class="exam-title" style="margin: 0; flex: 1;">${exam.title}</h4>
                                ${scheduleInfo}
                            </div>
                            <div class="exam-meta" style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <span>‚è± ${exam.duration}m</span>
                                    <span>‚ùì ${exam.questions ? exam.questions.length : 0} Qs</span>
                                    <span>üè´ ${exam.targetClass || 'All Classes'}</span>
                                </div>
                                ${isArchived
                            ? `<button class="btn" style="font-size: 0.75rem; padding: 3px 8px; color: var(--success-color); background: transparent; border: 1px solid #e0e0e0;" onclick="window.unarchiveExam('${exam.id}')">üì§ Restore</button>`
                            : `<button class="btn" style="font-size: 0.75rem; padding: 3px 8px; color: var(--light-text); background: transparent; border: 1px solid #e0e0e0;" onclick="window.archiveExam('${exam.id}')">üì• Archive</button>`
                        }
                            </div>
                        </div>
                        <div class="exam-card-footer">
                            <button class="btn" style="font-size: 0.8rem; padding: 4px 8px;" onclick="location.href='create-exam.html?id=${exam.id}'">‚úèÔ∏è Edit</button>
                            ${!isArchived ? `<button class="btn" style="font-size: 0.8rem; padding: 4px 8px;" onclick="window.openExtensionsModal('${exam.id}')">‚è±Ô∏è Extensions</button>` : ''}
                            <button class="btn" style="font-size: 0.8rem; padding: 4px 8px;" onclick="location.href='exam-results.html?examId=${exam.id}'">üìä Results</button>
                        </div>
                    </div>
                    `;
                };

                // Render active exams
                if (activeExams.length > 0) {
                    grid.innerHTML = activeExams.map(exam => renderExamCard(exam, false)).join('');
                } else {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìù</div>
                            <p>No active exams. Create your first exam to get started.</p>
                        </div>`;
                }

                // Render archived exams
                if (archivedExams.length > 0) {
                    archivedSection.style.display = 'block';
                    archivedCountEl.textContent = `(${archivedExams.length})`;
                    archivedGrid.innerHTML = archivedExams.map(exam => renderExamCard(exam, true)).join('');
                } else {
                    archivedSection.style.display = 'none';
                }

                // Initialize secret delete handlers for all cards
                if (window.initSecretDelete) {
                    window.initSecretDelete();
                }

            } catch (err) {
                console.error('Failed to load exams', err);
            }
            */
        });

        // --- Archive Logic ---
        window.archiveExam = async (examId) => {
            if (!(await Utils.showConfirm('Archive Exam', 'Archive this exam? It will be hidden from students and moved to the Archived section.'))) return;

            try {
                await dataService.updateExam(examId, { status: 'archived' });
                // Refresh the page to update the UI
                location.reload();
            } catch (err) {
                Utils.showAlert('Error', 'Failed to archive exam: ' + err.message);
            }
        };

        window.unarchiveExam = async (examId) => {
            if (!(await Utils.showConfirm('Restore Exam', 'Restore this exam? It will become visible to students again.'))) return;

            try {
                await dataService.updateExam(examId, { status: 'active' });
                // Refresh the page to update the UI
                location.reload();
            } catch (err) {
                Utils.showAlert('Error', 'Failed to restore exam: ' + err.message);
            }
        };

        window.toggleArchivedSection = () => {
            const grid = document.getElementById('archived-grid');
            const icon = document.getElementById('archive-toggle-icon');
            if (grid.style.display === 'none') {
                grid.style.display = 'grid';
                icon.textContent = '‚ñº';
            } else {
                grid.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        };

        // --- Secret Delete Logic ---
        let deleteExamId = null;
        let deleteExamTitle = null;
        let longPressTimer = null;
        const LONG_PRESS_DURATION = 800; // ms

        // Initialize secret delete event listeners after cards render
        window.initSecretDelete = () => {
            const cards = document.querySelectorAll('.exam-card[data-exam-id]');

            cards.forEach(card => {
                const examId = card.dataset.examId;
                const examTitle = card.dataset.examTitle;

                // Desktop: Double Click
                card.addEventListener('dblclick', (e) => {
                    // Prevent if clicking on a button
                    if (e.target.closest('button') || e.target.closest('a')) return;
                    e.preventDefault();
                    openDeleteModal(examId, examTitle);
                });

                // Mobile: Long Press
                card.addEventListener('touchstart', (e) => {
                    // Prevent if touching a button
                    if (e.target.closest('button') || e.target.closest('a')) return;

                    longPressTimer = setTimeout(() => {
                        // Vibrate if supported (mobile feedback)
                        if (navigator.vibrate) navigator.vibrate(50);
                        openDeleteModal(examId, examTitle);
                    }, LONG_PRESS_DURATION);
                }, { passive: true });

                card.addEventListener('touchend', () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });

                card.addEventListener('touchmove', () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
            });
        };

        window.openDeleteModal = (examId, examTitle) => {
            deleteExamId = examId;
            deleteExamTitle = examTitle;

            document.getElementById('delete-exam-title').textContent = `"${examTitle}"`;
            document.getElementById('delete-confirm-input').value = '';

            const confirmBtn = document.getElementById('delete-confirm-btn');
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
            confirmBtn.style.cursor = 'not-allowed';

            document.getElementById('delete-exam-modal').style.display = 'flex';

            // Focus the input after a short delay
            setTimeout(() => document.getElementById('delete-confirm-input').focus(), 100);
        };

        window.closeDeleteModal = () => {
            document.getElementById('delete-exam-modal').style.display = 'none';
            deleteExamId = null;
            deleteExamTitle = null;
        };

        // Enable delete button when title matches
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('delete-confirm-input');
            if (input) {
                input.addEventListener('input', (e) => {
                    const confirmBtn = document.getElementById('delete-confirm-btn');
                    const matches = e.target.value.trim().toLowerCase() === deleteExamTitle?.toLowerCase();
                    confirmBtn.disabled = !matches;
                    confirmBtn.style.opacity = matches ? '1' : '0.5';
                    confirmBtn.style.cursor = matches ? 'pointer' : 'not-allowed';
                });
            }
        });

        window.confirmDeleteExam = async () => {
            if (!deleteExamId) return;

            const confirmBtn = document.getElementById('delete-confirm-btn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '‚è≥ Deleting...';

            try {
                await dataService.deleteExam(deleteExamId);
                closeDeleteModal();

                Utils.showToast('Exam deleted successfully', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } catch (err) {
                await Utils.showAlert('Error', 'Failed to delete exam: ' + err.message);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'üóëÔ∏è Delete Forever';
            }
        };

        // --- Extensions Logic ---
        let currentExamExtensionsId = null;

        window.openExtensionsModal = async (examId) => {
            currentExamExtensionsId = examId;
            const exam = await dataService.getExamById(examId);
            if (!exam) return;

            document.getElementById('extensions-modal').style.display = 'flex';
            document.getElementById('ext-exam-title').textContent = `Exam: ${exam.title}`;

            // Load Participants (Students who started or submitted)
            const select = document.getElementById('ext-student-select');
            select.innerHTML = '<option value="">Loading students...</option>';

            try {
                // Get all results for this exam
                const results = await dataService.getResults({ examId: examId });

                // Map results to student data with flag count
                const participants = results.map(r => ({
                    id: r.studentId,
                    name: r.studentName,
                    flagCount: window.countActiveFlags(r.flags),
                    status: r.status
                }));

                // Sort: Flagged first, then alphabetical
                participants.sort((a, b) => {
                    if (b.flagCount !== a.flagCount) return b.flagCount - a.flagCount;
                    return a.name.localeCompare(b.name);
                });

                let opts = `<option value="GLOBAL" style="font-weight:bold;">-- ALL STUDENTS --</option>`;

                if (participants.length === 0) {
                    opts += `<option value="" disabled>No students have started this exam yet</option>`;
                } else {
                    opts += participants.map(p => {
                        const flagIcon = p.flagCount > 0 ? 'üö© ' : '';
                        const statusColor = p.status === 'in-progress' ? ' (In Progress)' : '';
                        return `<option value="${p.id}">${flagIcon}${p.name}${statusColor}</option>`;
                    }).join('');
                }

                select.innerHTML = opts;

                renderExtensionsList(exam, results);
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option value="">Error loading participants</option>';
            }
        };

        window.closeExtensionsModal = () => {
            document.getElementById('extensions-modal').style.display = 'none';
            currentExamExtensionsId = null;
            if (window.extensionsInterval) {
                clearInterval(window.extensionsInterval);
                window.extensionsInterval = null;
            }
        }

        window.saveExtension = async () => {
            if (!currentExamExtensionsId) return;
            const studentId = document.getElementById('ext-student-select').value;
            const minutes = parseInt(document.getElementById('ext-minutes').value);

            if (!studentId) return Utils.showAlert('Selection Required', 'Please select a student or "All Students"');
            if (isNaN(minutes) || minutes <= 0) return Utils.showAlert('Invalid Time', 'Please enter a valid number of minutes');

            try {
                const exam = await dataService.getExamById(currentExamExtensionsId);

                if (studentId === 'GLOBAL') {
                    // Global Extension
                    const globalExtension = {
                        addedMinutes: minutes,
                        grantedAt: new Date().toISOString()
                    };
                    await dataService.updateExam(currentExamExtensionsId, { globalExtension });
                } else {
                    // Specific Extension
                    const extensions = exam.extensions || {};
                    extensions[studentId] = {
                        addedMinutes: minutes,
                        grantedAt: new Date().toISOString()
                    };
                    await dataService.updateExam(currentExamExtensionsId, { extensions });
                }

                // Refresh list
                const updatedExam = await dataService.getExamById(currentExamExtensionsId);
                const results = await dataService.getResults({ examId: currentExamExtensionsId });
                renderExtensionsList(updatedExam, results);
                document.getElementById('ext-minutes').value = '';

                // Show success message without alert to avoid blocking the UI
                const successMsg = document.createElement('div');
                successMsg.textContent = '‚úì Extension saved successfully';
                successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success-color); color: white; padding: 12px 20px; border-radius: 8px; z-index: 9999; animation: fadeIn 0.3s;';
                document.body.appendChild(successMsg);
                setTimeout(() => {
                    successMsg.style.opacity = '0';
                    successMsg.style.transition = 'opacity 0.3s';
                    setTimeout(() => successMsg.remove(), 300);
                }, 2000);
            } catch (e) {
                await Utils.showAlert('Error', 'Failed to save: ' + e.message);
            }
        };

        async function removeExtension(studentId) {
            if (!currentExamExtensionsId) return;
            if (!(await Utils.showConfirm('Remove Extension', 'Remove this extension?'))) return;

            try {
                const exam = await dataService.getExamById(currentExamExtensionsId);

                if (studentId === 'GLOBAL') {
                    await dataService.updateExam(currentExamExtensionsId, { globalExtension: null });
                } else {
                    const extensions = exam.extensions || {};
                    delete extensions[studentId];
                    await dataService.updateExam(currentExamExtensionsId, { extensions });
                }

                const updatedExam = await dataService.getExamById(currentExamExtensionsId);
                const results = await dataService.getResults({ examId: currentExamExtensionsId });
                renderExtensionsList(updatedExam, results);
            } catch (e) {
                await Utils.showAlert('Error', 'Failed to remove extension: ' + e.message);
            }
        }

        // Expose removeExtension to window for onclick
        window.removeExtension = removeExtension;

        // Offline Prep Logic
        let messageModalCallback = null;

        function showMessageModal({ title, body, showConfirm = false, confirmText = 'Confirm', onConfirm = null }) {
            const modal = document.getElementById('message-modal');
            const titleEl = document.getElementById('msg-title');
            const bodyEl = document.getElementById('msg-body');
            const cancelBtn = document.getElementById('msg-cancel-btn');
            const confirmBtn = document.getElementById('msg-confirm-btn');

            titleEl.textContent = title;
            bodyEl.innerHTML = body.replace(/\n/g, '<br>');

            if (showConfirm) {
                confirmBtn.style.display = 'block';
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = closeMessageModal;
                cancelBtn.style.display = 'block';

                messageModalCallback = onConfirm;
                confirmBtn.onclick = () => {
                    if (messageModalCallback) messageModalCallback();
                };
            } else {
                confirmBtn.style.display = 'none';
                cancelBtn.textContent = 'Close';
                cancelBtn.onclick = closeMessageModal;
                cancelBtn.style.display = 'block';
            }

            modal.style.display = 'flex';
        }

        window.closeMessageModal = () => {
            document.getElementById('message-modal').style.display = 'none';
            messageModalCallback = null;
        }

        window.prepareDevice = async () => {
            showMessageModal({
                title: 'Prepare Offline Data',
                body: 'This will download all Student references and Active Exams to this computer for offline use.\n\nEnsure you are ONLINE.\n\nProceed?',
                showConfirm: true,
                confirmText: 'Download & Prepare',
                onConfirm: async () => {
                    // Loading State
                    document.getElementById('msg-title').textContent = 'Downloading...';
                    document.getElementById('msg-body').textContent = 'Please wait while we cache the data.';
                    document.getElementById('msg-confirm-btn').style.display = 'none';
                    document.getElementById('msg-cancel-btn').style.display = 'none';

                    try {
                        const user = dataService.getCurrentUser();
                        const stats = await dataService.prepareOfflineData(user.id);
                        // Success
                        showMessageModal({
                            title: 'Device Ready',
                            body: `Device Prepared Successfully!\n\nDownloaded:\n- ${stats.students} Students\n- ${stats.exams} Exams\n\nYou can now take this device offline.\nStudents can log in using their IDs.`
                        });
                    } catch (err) {
                        console.error(err);
                        showMessageModal({
                            title: 'Preparation Failed',
                            body: 'Error: ' + err.message
                        });
                    }
                }
            });
        };

        window.extensionsInterval = null;

        function renderExtensionsList(exam, results = []) {
            const list = document.getElementById('ext-list');
            const ext = exam.extensions || {};
            const studentIds = Object.keys(ext);
            const globalExt = exam.globalExtension;

            if (window.extensionsInterval) clearInterval(window.extensionsInterval);

            if (studentIds.length === 0 && !globalExt) {
                list.innerHTML = '<p style="font-size: 0.9rem; color: var(--light-text);">No extensions granted.</p>';
                return;
            }

            const selectOptions = Array.from(document.getElementById('ext-student-select').options);

            const updateTimers = () => {
                const now = new Date();
                let html = '';

                // Render Global First
                if (globalExt) {
                    const mins = globalExt.addedMinutes || Math.round((globalExt.multiplier - 1) * exam.duration);
                    html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color); background-color: rgba(46, 204, 113, 0.1); border-radius: 4px; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 700;">ALL STUDENTS</div>
                            <div style="font-size: 0.8rem; color: var(--success-color);">+${mins} Minutes Extra</div>
                        </div>
                        <button class="btn btn-outline" style="border-color: var(--accent-color); color: var(--accent-color); padding: 4px 8px; font-size: 0.8rem;" onclick="removeExtension('GLOBAL')">Remove</button>
                    </div>
                    `;
                }

                html += studentIds.map(sid => {
                    const data = ext[sid];
                    const opt = selectOptions.find(o => o.value === sid);
                    const name = opt ? opt.text.replace('üö© ', '').split(' (')[0] : sid;
                    const extraMins = data.addedMinutes || Math.round((data.multiplier - 1) * exam.duration);
                    const grantedAt = new Date(data.grantedAt);

                    // Calculate countdown from granted time
                    const extensionEndTime = new Date(grantedAt.getTime() + extraMins * 60000);
                    const diff = extensionEndTime - now;

                    let countdownHtml = '';
                    if (diff > 0) {
                        const totalSeconds = Math.floor(diff / 1000);
                        const m = Math.floor(totalSeconds / 60);
                        const s = totalSeconds % 60;
                        const timeStr = String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
                        countdownHtml = `<span style="font-family: monospace; font-weight: bold; color: var(--primary-color); background: rgba(74, 144, 226, 0.1); padding: 2px 6px; border-radius: 4px; margin-left: 8px;" title="Extension Time Remaining">‚è≥ ${timeStr}</span>`;
                    } else {
                        countdownHtml = `<span style="color: var(--accent-color); font-size: 0.8rem; margin-left: 8px;">‚åõ Expired</span>`;
                    }

                    return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; display: flex; align-items: center;">${name} ${countdownHtml}</div>
                            <div style="font-size: 0.8rem; color: var(--success-color);">+${extraMins} Minutes Extra</div>
                        </div>
                        <button class="btn btn-outline" style="border-color: var(--accent-color); color: var(--accent-color); padding: 4px 8px; font-size: 0.8rem;" onclick="removeExtension('${sid}')">Remove</button>
                    </div>
                    `;
                }).join('');

                list.innerHTML = html;
            };

            updateTimers();
            window.extensionsInterval = setInterval(updateTimers, 1000);
        }

        // --- Flag Review Features ---
        let currentFlaggedResults = [];
        let cachedExams = [];
        let cachedResults = [];

        window.openFlagReviewModal = async () => {
            await loadAndRenderFlags();
            document.getElementById('flag-review-modal').style.display = 'flex';
        };

        // Helper function for mobile - closes menu before opening modal
        window.openFlagReviewModalFromMobile = async () => {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');

            // Close mobile menu
            if (menu && menu.classList.contains('show')) {
                menu.classList.remove('show');
                if (btn) btn.textContent = '‚ò∞';
            }

            // Open modal
            await openFlagReviewModal();
        };

        // New function to open flag review modal filtered by exam ID
        window.openFlagReviewModalForExam = async (examId) => {
            await loadAndRenderFlags(examId);
            document.getElementById('flag-review-modal').style.display = 'flex';
        };

        // Split load logic for reuse
        async function loadAndRenderFlags(filterExamId = null) {
            const body = document.getElementById('flag-review-body');
            // Only show loading if empty cache, otherwise implicit update
            if (cachedResults.length === 0) body.innerHTML = '<p>Loading flagged submissions...</p>';

            try {
                // Fetch fresh data
                const user = dataService.getCurrentUser();
                const [exams, allResults] = await Promise.all([
                    dataService.getExams({ teacherId: user.id }),
                    dataService.getResults()
                ]);

                cachedExams = exams;
                cachedResults = allResults;

                processAndRenderUi(filterExamId);

            } catch (e) {
                console.error(e);

                // If offline and we have cached data, use it
                if (!navigator.onLine && cachedExams.length > 0 && cachedResults.length > 0) {
                    console.warn('Offline: Using cached data for flag review');
                    processAndRenderUi(filterExamId);

                    // Show offline indicator in modal
                    const modalHeader = document.querySelector('#flag-review-modal .modal-header h3');
                    if (modalHeader && !modalHeader.textContent.includes('üî¥')) {
                        modalHeader.textContent = 'üî¥ Review Flagged Questions (Offline Mode)';
                    }
                } else if (!navigator.onLine) {
                    body.innerHTML = `<div class="empty-state"><p>‚ùå You are offline and no cached data is available.</p><p>Please connect to the internet to view flagged questions.</p></div>`;
                } else {
                    body.innerHTML = `<p style="color:red">Error loading flags: ${e.message}</p>`;
                }
            }
        }

        function processAndRenderUi(filterExamId = null) {
            // 1. Update Dashboard Stats (Exam Cards and Pending Counts)
            updateDashboardStats(cachedExams, cachedResults);

            // 2. Build Flagged List
            currentFlaggedResults = [];

            for (const res of cachedResults) {
                const flagsObj = res.flags || {};
                const activeFlagKeys = Object.entries(flagsObj)
                    // Use robust check matching helper
                    .filter(([k, v]) => {
                        if (k.startsWith('_')) return false;
                        if (typeof v === 'object') return false;
                        return v === true || String(v).toLowerCase() === 'true';
                    })
                    .map(([k, v]) => k);

                if (activeFlagKeys.length > 0) {
                    const exam = cachedExams.find(e => e.id === res.examId);
                    if (exam) {
                        currentFlaggedResults.push({
                            result: res,
                            exam: exam,
                            flaggedQuestionIds: activeFlagKeys
                        });
                    }
                }
            }

            // 3. Render Modal List
            renderFlagReviewList(filterExamId);
        }

        // --- Dashboard Data Loading Strategy (Cache-then-Network) ---
        // Using globally defined cachedExams/cachedResults (see Flag Review section)

        async function loadDashboardData() {
            const user = dataService.getCurrentUser();
            if (!user) return;

            // 1. Load from IDB Cache Immediately (UI Speed)
            if (window.idb) {
                try {
                    const [cExams, cResults] = await Promise.all([
                        window.idb.getDashboardCache(`exams_${JSON.stringify({ teacherId: user.id })}`),
                        window.idb.getDashboardCache('results_all')
                    ]);

                    if (cExams && cExams.data) {
                        cachedExams = cExams.data;
                        updateDashboardStats(cachedExams, cachedResults || []);
                    }
                    if (cResults && cResults.data) {
                        cachedResults = cResults.data;
                        updateDashboardStats(cachedExams || [], cachedResults);
                    }
                } catch (e) {
                    console.warn('Cache load error:', e);
                }
            }

            // 2. Fetch Fresh Data from Network (Background Update)
            try {
                // If we have no cache, show loading state
                const grid = document.getElementById('exams-grid');
                if (cachedExams.length === 0 && grid) {
                    grid.innerHTML = '<div class="loader"></div>';
                }

                console.log('üåê Fetching fresh dashboard data...');
                const [exams, results] = await Promise.all([
                    dataService.getExams({ teacherId: user.id, forceRefresh: true }),
                    dataService.getResults({ forceRefresh: true })
                ]);

                cachedExams = exams;
                cachedResults = results;

                // 3. Update Cache (implicitly done by dataService but good to be explicit for dashboard specific keys if needed)
                if (window.idb) {
                    await window.idb.saveDashboardCache('results_all', { data: results, timestamp: Date.now() });
                }

                updateDashboardStats(exams, results);

            } catch (error) {
                console.error('Error loading dashboard:', error);

                // If offline and we have cache, we are good.
                if (cachedExams.length > 0) {
                    // showToast('You are offline. Showing cached data.', 'info'); 
                    const el = document.getElementById('connection-status');
                    if (el) {
                        el.textContent = 'üî¥ Offline';
                        el.style.backgroundColor = '#f8d7da';
                        el.style.color = '#721c24';
                    }
                } else if (!navigator.onLine) {
                    const grid = document.getElementById('exams-grid');
                    if (grid) grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì°</div>
                            <h3>You are offline</h3>
                            <p>No cached data available. Please connect to the internet.</p>
                        </div>
                    `;
                } else {
                    await Utils.showAlert('Error', 'Failed to load dashboard: ' + error.message);
                }
            }
        }

        // Helper to update main dashboard counters without full reload
        function updateDashboardStats(exams, allResults) {
            // Count distinct STUDENTS with active flags (not total flags)
            const pendingCount = allResults.filter(r => window.countActiveFlags(r.flags) > 0).length;

            // Update desktop Results Pending counter
            const pEl = document.getElementById('results-pending-count');
            if (pEl) pEl.textContent = pendingCount;

            // Update mobile Results Pending counter (Task 3)
            const mpEl = document.getElementById('mobile-results-pending-count');
            if (mpEl) mpEl.textContent = pendingCount;

            // Filter to only show ACTIVE exams (not archived)
            const activeExams = exams.filter(e => e.status !== 'archived');

            // Update total exams count (only active)
            const totalExamsEl = document.getElementById('total-exams');
            if (totalExamsEl) totalExamsEl.textContent = activeExams.length;
            const mobileTotalEl = document.getElementById('mobile-total-exams');
            if (mobileTotalEl) mobileTotalEl.textContent = activeExams.length;

            const grid = document.getElementById('exams-grid');
            if (!grid) return;

            // Helper to generate Card HTML
            const getCardHTML = (exam, isArchived = false) => {
                const examResults = allResults.filter(r => r.examId === exam.id);
                const greenCount = examResults.filter(r => r.status === 'completed' && window.countActiveFlags(r.flags) === 0).length;
                const yellowCount = examResults.filter(r => r.status === 'in-progress').length;
                const redCount = examResults.reduce((sum, r) => sum + window.countActiveFlags(r.flags), 0);

                let scheduleInfo = '';
                if (exam.scheduledDate) {
                    const schedDate = new Date(exam.scheduledDate);
                    const now = new Date();
                    const isPast = schedDate < now;
                    const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                    scheduleInfo = `<span style="color: ${isPast ? 'var(--success-color)' : 'var(--accent-color)'}; font-size: 0.85rem;">üìÖ ${schedDate.toLocaleDateString('en-US', options)}${isPast ? ' ‚úì' : ''}</span>`;
                }

                const scrambleIndicator = exam.scrambleQuestions
                    ? '<span title="Questions scrambled" style="font-size: 0.85rem;">üîÄ</span>'
                    : '';

                return `
                    <div class="exam-card-header" style="justify-content: space-between; align-items: center;">
                        <span class="exam-subject">${exam.subject || 'General'}</span>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${scrambleIndicator}
                            <span title="Completed" style="font-size: 0.9rem;">üü¢ ${greenCount}</span>
                            <span title="In Progress" style="font-size: 0.9rem;">üü° ${yellowCount}</span>
                            <span title="Flagged - Click to review" style="font-size: 0.9rem; cursor: pointer;" onclick="event.stopPropagation(); openFlagReviewModalForExam('${exam.id}')">üî¥ ${redCount}</span>
                        </div>
                    </div>
                    <div class="exam-card-body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                            <h4 class="exam-title" style="margin: 0;">${exam.title}</h4>
                            ${scheduleInfo}
                        </div>
                        <div class="exam-meta" style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <span>‚è± ${exam.duration}m</span>
                                <span>‚ùì ${exam.questions ? exam.questions.length : 0} Qs</span>
                                <span>üè´ ${exam.targetClass || 'All Classes'}</span>
                            </div>
                            ${isArchived
                        ? `<button class="btn" style="font-size: 0.75rem; padding: 3px 8px; color: var(--success-color); background: transparent; border: 1px solid #e0e0e0;" onclick="window.unarchiveExam('${exam.id}')">üì§ Restore</button>`
                        : `<button class="btn" style="font-size: 0.75rem; padding: 3px 8px; color: var(--light-text); background: transparent; border: 1px solid #e0e0e0;" onclick="window.archiveExam('${exam.id}')">üì• Archive</button>`
                    }
                        </div>
                    </div>
                    <div class="exam-card-footer">
                        <button class="btn" style="font-size: 0.8rem; padding: 4px 8px;" onclick="location.href='create-exam.html?id=${exam.id}'">‚úèÔ∏è Edit</button>
                        ${!isArchived ? `<button class="btn" style="font-size: 0.8rem; padding: 4px 8px;" onclick="window.openExtensionsModal('${exam.id}')">‚è±Ô∏è Extensions</button>` : ''}
                        <button class="btn" style="font-size: 0.8rem; padding: 4px 8px;" onclick="location.href='exam-results.html?examId=${exam.id}'">üìä Results</button>
                    </div>
                `;
            };

            // Smart Update:
            // 1. Mark all existing cards
            const currentCards = Array.from(grid.children);
            const existingIds = new Set(currentCards.map(c => c.getAttribute('data-exam-id')));
            const newIds = new Set(activeExams.map(e => e.id));

            // 2. Remove cards for exams that are no longer active/exist
            currentCards.forEach(card => {
                const id = card.getAttribute('data-exam-id');
                if (!newIds.has(id)) {
                    card.remove();
                }
            });

            // 3. Update existing or Append new
            activeExams.forEach(exam => {
                let card = grid.querySelector(`.exam-card[data-exam-id="${exam.id}"]`);

                if (card) {
                    // Update content
                    card.innerHTML = getCardHTML(exam, false);
                    card.setAttribute('data-exam-title', exam.title); // Update title just in case
                } else {
                    // Create new
                    card = document.createElement('div');
                    card.className = 'exam-card';
                    card.setAttribute('data-exam-id', exam.id);
                    card.setAttribute('data-exam-title', exam.title);
                    card.innerHTML = getCardHTML(exam, false);
                    // Prepend to top (assuming sort order) or append
                    grid.prepend(card);
                }
            });

            // If grid is empty
            if (activeExams.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <h3>No Exams Created Yet</h3>
                        <p>Create your first exam to get started.</p>
                        <button class="btn btn-primary" onclick="location.href='create-exam.html'">+ Create Exam</button>
                    </div>
                `;
            } else {
                // Remove empty state if present
                const empty = grid.querySelector('.empty-state');
                if (empty) empty.remove();
            }

            // Also handle archived grid (simpler: just rebuild)
            const archivedGrid = document.getElementById('archived-grid');
            const archivedExams = exams.filter(e => e.status === 'archived');
            if (archivedGrid) {
                if (archivedExams.length > 0) {
                    document.getElementById('archived-section').style.display = 'block';
                    document.getElementById('archived-count').textContent = `(${archivedExams.length})`;
                    archivedGrid.innerHTML = archivedExams.map(exam => `
                        <div class="exam-card" data-exam-id="${exam.id}" data-exam-title="${exam.title}" style="opacity: 0.7;">
                            ${getCardHTML(exam, true)}
                        </div>
                    `).join('');
                } else {
                    document.getElementById('archived-section').style.display = 'none';
                }
            }

            // Re-bind secret delete events (since we might have added new cards)
            if (window.initSecretDelete) window.initSecretDelete();
        }

        window.closeFlagReviewModal = () => {
            document.getElementById('flag-review-modal').style.display = 'none';
        }

        function renderFlagReviewList(filterExamId = null) {
            const body = document.getElementById('flag-review-body');
            const modalHeader = document.querySelector('#flag-review-modal .modal-header h3');

            // Task 4: Filter out any entries that have no active flags remaining
            let activeGroups = currentFlaggedResults.filter(entry => entry.flaggedQuestionIds.length > 0);

            // If filtering by exam ID, only show flags for that exam
            if (filterExamId) {
                activeGroups = activeGroups.filter(entry => entry.exam.id === filterExamId);

                // Update modal header to show filtered exam
                if (activeGroups.length > 0 && modalHeader) {
                    const examTitle = activeGroups[0].exam.title;
                    modalHeader.textContent = `üî¥ Review Flagged Questions - ${examTitle}`;
                }
            } else {
                // Reset header to default when showing all
                if (modalHeader && !modalHeader.textContent.includes('Offline')) {
                    modalHeader.textContent = 'üî¥ Review Flagged Questions';
                }
            }

            if (activeGroups.length === 0) {
                body.innerHTML = '<div class="empty-state"><p>No pending flagged questions.</p></div>';
                return;
            }

            let html = '';

            activeGroups.forEach(({ result, exam, flaggedQuestionIds }) => {
                html += `
                <div class="flag-group" style="margin-bottom: 30px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px;">
                        <div>
                            <strong>${result.studentName}</strong> <span style="opacity: 0.7;">- ${exam.title}</span>
                        </div>
                        <div>
                            <button class="btn btn-outline" style="font-size:0.8rem; padding: 2px 6px;" onclick="window.openExtensionsModal('${exam.id}')">Grant Extension</button>
                        </div>
                    </div>
                `;

                flaggedQuestionIds.forEach(qId => {
                    // Find question by ID
                    const qIndex = exam.questions.findIndex(q => q.id == qId);
                    const question = (qIndex >= 0) ? exam.questions[qIndex] : null;
                    const qText = question ? question.text : 'Question not found (ID ' + qId + ')';
                    const displayIndex = (qIndex >= 0) ? qIndex + 1 : '?';

                    html += `
                    <div class="flag-item">
                        <div class="flag-header" style="font-weight: bold; margin-bottom: 5px; color: #cc0000;">Flagged Question #${displayIndex}</div>
                        <div style="margin-bottom: 8px; font-style: italic;">"${qText}"</div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-outline" style="font-size: 0.8rem;" onclick="openEditQuestion('${exam.id}', ${qIndex})">‚úèÔ∏è Edit Question</button>
                            <button class="btn btn-primary" style="font-size: 0.8rem; background-color: #2ecc71; border-color: #2ecc71;" onclick="resolveFlag('${result.id}', '${qId}')">‚úî Resolve</button>
                        </div>
                    </div>
                    `;
                });

                html += `</div>`;
            });

            body.innerHTML = html;
        }

        window.openEditQuestion = async (examId, qIndex) => {
            try {
                const exam = await dataService.getExamById(examId);
                if (!exam || !exam.questions[qIndex]) return;

                const q = exam.questions[qIndex];
                const qText = document.getElementById('edit-q-text');
                qText.value = q.text;
                qText.oninput = (e) => {
                    e.target.style.height = 'auto';
                    e.target.style.height = (e.target.scrollHeight) + 'px';
                };

                document.getElementById('edit-q-type').value = q.type || 'mcq';
                document.getElementById('edit-q-exam-id').value = examId;
                document.getElementById('edit-q-index').value = qIndex;

                // Initial expand
                setTimeout(() => {
                    qText.style.height = 'auto';
                    qText.style.height = (qText.scrollHeight) + 'px';
                }, 100);

                // Render Options
                const container = document.getElementById('edit-q-options-container');
                container.innerHTML = '';

                if (q.options && Array.isArray(q.options)) {
                    q.options.forEach((opt, i) => {
                        // Handle Object vs String options
                        const val = (typeof opt === 'object' && opt !== null) ? (opt.text || '') : opt;

                        container.innerHTML += `
                        <div class="answer-option" style="display: flex; gap: 5px; align-items: flex-start; margin-bottom: 8px; background: var(--card-bg); padding: 8px; border-radius: 6px; border: 1px solid var(--border-color);">
                            <span style="font-weight: bold; width: 25px; margin-top: 8px;">${String.fromCharCode(65 + i)}.</span>
                            <textarea class="form-control edit-option-input auto-expand" data-index="${i}" style="flex: 1; min-height: 40px; height: 40px; resize: none; overflow: hidden;" oninput="this.style.height='auto'; this.style.height=(this.scrollHeight)+'px'">${val}</textarea>
                            <button type="button" class="btn btn-outline" onclick="removeEditOption(${i})" style="padding: 5px 10px; min-width: auto; margin-top: 5px;">‚úï</button>
                        </div>
                       `;
                    });

                    // Trigger initial height adjustment
                    setTimeout(() => {
                        container.querySelectorAll('textarea').forEach(ta => {
                            ta.style.height = 'auto';
                            ta.style.height = ta.scrollHeight + 'px';
                        });
                    }, 100);
                }

                document.getElementById('edit-question-modal').style.display = 'flex';
            } catch (e) {
                await Utils.showAlert('Error', 'Error loading question: ' + e.message);
            }
        }

        window.addEditOption = async () => {
            const container = document.getElementById('edit-q-options-container');
            const currentCount = container.querySelectorAll('.edit-option-input').length;

            if (currentCount >= 10) {
                await Utils.showAlert('Limit Reached', 'Maximum 10 options allowed');
                return;
            }

            const newIndex = currentCount;
            const optionHtml = `
                <div class="answer-option" style="display: flex; gap: 5px; align-items: flex-start; margin-bottom: 8px; background: var(--card-bg); padding: 8px; border-radius: 6px; border: 1px solid var(--border-color);">
                    <span style="font-weight: bold; width: 25px; margin-top: 8px;">${String.fromCharCode(65 + newIndex)}.</span>
                    <textarea class="form-control edit-option-input auto-expand" data-index="${newIndex}" style="flex: 1; min-height: 40px; height: 40px; resize: none; overflow: hidden;" placeholder="Enter option text" oninput="this.style.height='auto'; this.style.height=(this.scrollHeight)+'px'"></textarea>
                    <button type="button" class="btn btn-outline" onclick="removeEditOption(${newIndex})" style="padding: 5px 10px; min-width: auto; margin-top: 5px;">‚úï</button>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', optionHtml);
        }

        window.removeEditOption = async (index) => {
            const container = document.getElementById('edit-q-options-container');
            const options = container.querySelectorAll('div[style*="display: flex"]');

            if (options.length <= 2) {
                await Utils.showAlert('Error', 'Minimum 2 options required');
                return;
            }

            // Remove the option
            options[index].remove();

            // Re-index remaining options
            const remainingOptions = container.querySelectorAll('div[style*="display: flex"]');
            remainingOptions.forEach((optDiv, i) => {
                const label = optDiv.querySelector('span');
                const input = optDiv.querySelector('input');
                const deleteBtn = optDiv.querySelector('button');

                label.textContent = String.fromCharCode(65 + i) + '.';
                input.setAttribute('data-index', i);
                deleteBtn.setAttribute('onclick', `removeEditOption(${i})`);
            });
        }

        window.saveQuestionEdit = async () => {
            const examId = document.getElementById('edit-q-exam-id').value;
            const qIndex = parseInt(document.getElementById('edit-q-index').value);
            const newText = document.getElementById('edit-q-text').value;
            const newType = document.getElementById('edit-q-type').value;

            // Gather Options
            const optionInputs = document.querySelectorAll('.edit-option-input');
            const newOptions = Array.from(optionInputs).map(input => input.value.trim()); // Strings

            if (!newText.trim()) return Utils.showAlert('Missing Info', 'Question text cannot be empty');
            if (newOptions.some(o => !o)) return Utils.showAlert('Missing Info', 'All options must be filled');

            try {
                const exam = await dataService.getExamById(examId);
                const originalQ = exam.questions[qIndex];

                // Update Text & Type
                originalQ.text = newText;
                originalQ.type = newType;

                // Update Options - Preserve Object Structure if needed
                if (originalQ.options && originalQ.options.length > 0 && typeof originalQ.options[0] === 'object') {
                    originalQ.options = originalQ.options.map((oldOpt, i) => {
                        if (typeof oldOpt === 'object') {
                            return { ...oldOpt, text: newOptions[i] || '' };
                        }
                        return { text: newOptions[i] || '' };
                    });
                } else {
                    originalQ.options = newOptions;
                }

                // Update Exam
                await dataService.updateExam(examId, { questions: exam.questions });

                await Utils.showAlert('Success', 'Question and options updated successfully.');
                document.getElementById('edit-question-modal').style.display = 'none';

                // Reload list to show updated text
                openFlagReviewModal();
            } catch (e) {
                await Utils.showAlert('Error', 'Failed to update: ' + e.message);
            }
        }

        window.resolveFlag = async (resultId, flagKey) => {
            // Check if online first
            if (!navigator.onLine) {
                await Utils.showAlert('Offline', '‚ùå You are offline. Cannot resolve flags without an internet connection.\n\nPlease connect to the internet and try again.');
                return;
            }

            if (!(await Utils.showConfirm('Resolve Flag', 'Mark this flag as resolved? Student will have 30 minutes to review.'))) return;

            try {
                // --- INSTANT UI UPDATE (Local Patch FIRST) ---
                // Find result in cache and update it immediately
                const cachedRes = cachedResults.find(r => r.id === resultId);
                if (!cachedRes) {
                    throw new Error('Result not found in cache');
                }

                console.log('Original flags:', JSON.stringify(cachedRes.flags));

                // Create updated flags object
                const updatedFlags = { ...(cachedRes.flags || {}) };

                // Update flag to resolved state with deadline (30 minutes from now)
                const deadline = new Date(Date.now() + 30 * 60000).toISOString();
                updatedFlags[flagKey] = {
                    status: 'resolved',
                    deadline: deadline
                };

                console.log('Updated flags to save:', JSON.stringify(updatedFlags));

                // Update cache immediately
                cachedRes.flags = updatedFlags;

                // Trigger immediate re-render with updated local data
                // This removes the resolved question from the modal instantly
                processAndRenderUi();

                // Now update the database using dataService method
                console.log('Updating database for result ID:', resultId);

                const updatedResult = await dataService.updateResult(resultId, {
                    flags: updatedFlags
                });

                console.log('Database update successful:', updatedResult);

                // Verify the update
                if (updatedResult && updatedResult.flags && updatedResult.flags[flagKey]) {
                    const dbFlag = updatedResult.flags[flagKey];
                    if (typeof dbFlag === 'object' && dbFlag.status === 'resolved') {
                        console.log('‚úÖ Flag successfully persisted as resolved in database');
                    } else {
                        console.warn('‚ö†Ô∏è Flag in database does not match expected resolved state:', dbFlag);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Flag key not found in database after update');
                }

            } catch (e) {
                console.error('Failed to resolve flag:', e);

                // Check if error is due to network issues
                if (!navigator.onLine || e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
                    await Utils.showAlert('Connection Error', '‚ùå Lost internet connection. The flag was not resolved.\n\nPlease check your connection and try again.');
                } else {
                    await Utils.showAlert('Error', 'Failed to resolve flag: ' + e.message);
                }

                // On error, reload to restore correct state
                loadAndRenderFlags().catch(console.error);
            }
        }
        // Change Password Functions
        window.openChangePasswordModal = function () {
            document.getElementById('change-password-modal').style.display = 'flex';
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            const errorEl = document.getElementById('password-error');
            if (errorEl) errorEl.style.display = 'none';
        };

        window.closeChangePasswordModal = function () {
            document.getElementById('change-password-modal').style.display = 'none';
        };

        window.togglePasswordVisibility = function (inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üîí';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        };

        window.submitPasswordChange = async function () {
            const oldPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-new-password').value;
            const errorEl = document.getElementById('password-error');
            const submitBtn = document.getElementById('submit-password-btn');

            if (!oldPass || !newPass || !confirmPass) {
                errorEl.textContent = 'Please fill in all fields';
                errorEl.style.display = 'block';
                return;
            }

            if (newPass !== confirmPass) {
                errorEl.textContent = 'New passwords do not match';
                errorEl.style.display = 'block';
                return;
            }

            if (newPass.length < 8) {
                errorEl.textContent = 'New password must be at least 8 characters';
                errorEl.style.display = 'block';
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Updating...';
                errorEl.style.display = 'none';

                await dataService.updatePassword(oldPass, newPass);

                await Utils.showAlert('Success', 'Password updated successfully! Please login again with your new password.');
                auth.logout();
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to update password';
                errorEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Password';
            }
        };


        // Credentials Dropdown Functions
        window.toggleCredentialsDropdown = function () {
            const content = document.getElementById('credentials-dropdown-content');
            content.classList.toggle('show');

            // Close when clicking outside
            const closeHandler = (e) => {
                if (!e.target.closest('.credentials-dropdown')) {
                    content.classList.remove('show');
                    document.removeEventListener('click', closeHandler);
                }
            };

            if (content.classList.contains('show')) {
                setTimeout(() => document.addEventListener('click', closeHandler), 10);
            }
        };

        // Change Username Functions
        window.openChangeUsernameModal = function () {
            document.getElementById('change-username-modal').style.display = 'flex';
            const user = dataService.getCurrentUser();
            if (user) {
                document.getElementById('new-username').value = user.username || '';
            }
            document.getElementById('username-error').style.display = 'none';
            // Close dropdown if open
            const content = document.getElementById('credentials-dropdown-content');
            if (content) content.classList.remove('show');
        };

        window.closeChangeUsernameModal = function () {
            document.getElementById('change-username-modal').style.display = 'none';
        };

        window.submitUsernameChange = async function () {
            const newUsername = document.getElementById('new-username').value.trim();
            const errorEl = document.getElementById('username-error');
            const submitBtn = document.getElementById('submit-username-btn');

            if (!newUsername) {
                errorEl.textContent = 'Username cannot be empty';
                errorEl.style.display = 'block';
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Updating...';
                errorEl.style.display = 'none';

                await dataService.updateUsername(newUsername);

                await Utils.showAlert('Success', 'Username updated successfully!');

                // Update nav display if needed
                const navDisplay = document.getElementById('nav-user-display');
                if (navDisplay) navDisplay.textContent = `üë§ ${newUsername}`;

                closeChangeUsernameModal();
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to update username';
                errorEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Username';
            }
        };

        // Update nav display initially
        document.addEventListener('DOMContentLoaded', () => {
            const user = dataService.getCurrentUser();
            if (user && user.username) {
                const navDisplay = document.getElementById('nav-user-display');
                if (navDisplay) navDisplay.textContent = `üë§ ${user.username}`;
            }
        });
        // Initialize connection monitoring
        setupConnectionMonitoring();
    </script>
</body>

</html>