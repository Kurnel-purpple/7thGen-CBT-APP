<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="client-id" content="seatos">
    <title>Admin Dashboard - CBT</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="manifest" href="../manifest.json">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .admin-header h1 {
            margin: 0 0 10px 0;
            font-size: 2rem;
        }

        .admin-header p {
            margin: 0;
            opacity: 0.9;
        }

        .admin-controls {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 200, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
            border-right: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--light-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }


        .section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .exam-grid {
            display: grid;
            gap: 15px;
        }

        .exam-card {
            background: var(--inner-bg);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .exam-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }

        /* Collapsible Groups Styling */
        .collapsible-group {
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            background: var(--card-bg);
        }

        .collapsible-header {
            padding: 15px 20px;
            background: var(--inner-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            border-bottom: 1px solid transparent;
        }

        .collapsible-header:hover {
            background: rgba(var(--primary-rgb, 74, 144, 200), 0.05);
        }

        .collapsible-header.active {
            border-bottom-color: var(--border-color);
        }

        .collapsible-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapsible-header .toggle-icon {
            transition: transform 0.3s;
            font-size: 0.8rem;
            opacity: 0.5;
        }

        .collapsible-header.active .toggle-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            display: none;
            padding: 15px;
        }

        .collapsible-content.active {
            display: block;
        }

        .group-count {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .exam-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .exam-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0 0 5px 0;
        }

        .exam-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .exam-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-draft {
            background: #fff3e0;
            color: #e65100;
        }

        .status-archived {
            background: #f5f5f5;
            color: #616161;
        }

        .messaging-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .message-form {
            background: var(--inner-bg);
            padding: 20px;
            border-radius: 10px;
        }

        .message-form textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 15px;
        }

        .message-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 200, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 200, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            opacity: 0.9;
        }

        .message-history {
            background: var(--inner-bg);
            padding: 20px;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary-color);
        }

        .message-item .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .message-item .message-to {
            font-weight: 600;
            color: var(--text-color);
        }

        .message-item .message-date {
            color: var(--light-text);
        }

        .message-item.received {
            border-left: 3px solid var(--success-color);
        }

        .message-item.reset-request {
            border-left: 3px solid var(--accent-color);
            background-color: var(--inner-bg);
        }

        .message-item.reset-request .message-content {
            font-family: monospace;
            white-space: pre-wrap;
            color: var(--accent-color);
            background: #fff0f1;
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }


        .message-item .message-content {
            color: var(--text-color);
            line-height: 1.5;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--light-text);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .logout-btn {
            background: var(--error-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .messaging-section {
                grid-template-columns: 1fr;
            }

            .admin-header {
                padding: 20px 15px;
                text-align: center;
                border-radius: 0;
                margin-bottom: 20px;
            }

            .admin-header>div {
                flex-direction: column;
                gap: 15px;
            }

            .admin-header h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .header-actions button {
                width: 100%;
            }
        }

        /* Dark Mode Support */
        [data-theme="dark"] body {
            background-color: #1a1a2e;
            color: #eee;
        }

        [data-theme="dark"] .admin-container {
            background-color: #1a1a2e;
        }

        [data-theme="dark"] .admin-controls,
        [data-theme="dark"] .section,
        [data-theme="dark"] .stat-card {
            background: #16213e;
            border-color: #0f3460;
        }

        [data-theme="dark"] .control-group label {
            color: #eee;
        }

        [data-theme="dark"] .control-group select,
        [data-theme="dark"] .control-group input,
        [data-theme="dark"] .form-control {
            background: #1a1a2e;
            border-color: #0f3460;
            color: #eee;
        }

        [data-theme="dark"] .exam-card {
            background: #1a1a2e;
            border-color: #0f3460;
        }

        [data-theme="dark"] .exam-card:hover {
            border-color: var(--primary-color);
        }

        [data-theme="dark"] .exam-title {
            color: #eee;
        }

        [data-theme="dark"] .exam-meta {
            color: #aaa;
        }

        [data-theme="dark"] .section-header h2 {
            color: #eee;
        }

        [data-theme="dark"] .section-header {
            border-color: #0f3460;
        }

        [data-theme="dark"] .message-form {
            background: #1a1a2e;
        }

        [data-theme="dark"] .message-form textarea {
            background: #16213e;
            border-color: #0f3460;
            color: #eee;
        }

        [data-theme="dark"] .message-history {
            background: #1a1a2e;
        }

        [data-theme="dark"] .message-item {
            background: #16213e;
        }

        [data-theme="dark"] .message-item .message-to {
            color: #eee;
        }

        [data-theme="dark"] .message-item .message-content {
            color: #ccc;
        }

        [data-theme="dark"] .status-active {
            background: #1b4332;
            color: #52b788;
        }

        [data-theme="dark"] .status-draft {
            background: #4a3000;
            color: #ffc107;
        }

        [data-theme="dark"] .status-archived {
            background: #333;
            color: #999;
        }

        [data-theme="dark"] .stat-card h3 {
            color: #aaa;
        }

        [data-theme="dark"] .stat-card .value {
            color: var(--primary-color);
        }

        [data-theme="dark"] .empty-state {
            color: #888;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: transform 0.3s, background 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Fix scrolling - ensure page is scrollable */
        html,
        body {
            height: auto;
            min-height: 100%;
            overflow-x: hidden;
            overflow-y: auto !important;
        }

        .admin-container {
            min-height: 100vh;
            padding-bottom: 80px;
        }


        /* Ensure exam grid allows scrolling */
        .exam-grid {
            max-height: none;
            overflow: visible;
        }

        /* Section should not restrict height */
        .section {
            max-height: none;
            overflow: visible;
        }

        /* Mobile Layout & Menu Styles */
        .mobile-only {
            display: none !important;
        }

        .hamburger-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
        }

        .mobile-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 80%;
            max-width: 350px;
            height: 100vh;
            background: var(--card-bg);
            z-index: 2000;
            transition: transform 0.3s ease, visibility 0.3s;
            transform: translateX(100%);
            visibility: hidden;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            padding: 25px;
            border-left: 1px solid var(--border-color);
        }

        .mobile-menu.active {
            transform: translateX(0);
            visibility: visible;
        }

        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
            backdrop-filter: blur(2px);
        }

        .mobile-menu-overlay.active {
            display: block;
        }

        /* Ensure overlay never shows on desktop */
        @media (min-width: 769px) {
            .mobile-menu-overlay {
                display: none !important;
            }
        }

        .mobile-stats-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card-mini {
            background: var(--inner-bg);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-card-mini h4 {
            margin: 0;
            font-size: 0.7rem;
            color: var(--light-text);
            text-transform: uppercase;
        }

        .stat-card-mini .val {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 4px;
        }

        .header-loader-mobile {
            display: flex;
            gap: 8px;
            width: 100%;
            margin-top: 15px;
        }

        .header-loader-mobile input {
            padding: 8px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        .header-loader-mobile button {
            padding: 8px 15px;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .desktop-only {
                display: none !important;
            }

            .mobile-only {
                display: flex !important;
            }

            .admin-header h1 {
                font-size: 1.4rem;
            }

            .admin-header p {
                font-size: 0.8rem;
            }

            .admin-header {
                padding: 15px;
                border-radius: 0;
                margin-bottom: 15px;
            }

            /* Responsive Header Styling */
            .responsive-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .responsive-header .header-main {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .responsive-header .header-title {
                margin: 0;
                font-size: 1.1rem;
            }

            .responsive-header .header-sub {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: auto;
                gap: 15px;
            }

            .badge {
                padding: 2px 10px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: bold;
                display: inline-block;
            }

            .badge-primary {
                background: var(--primary-color);
                color: white;
            }

            .view-link {
                color: var(--primary-color);
                font-weight: bold;
                font-size: 0.85rem;
            }

            @media (max-width: 500px) {
                .responsive-header .header-main {
                    width: 100%;
                    justify-content: space-between;
                    margin-bottom: 5px;
                }

                .responsive-header .header-sub {
                    width: 100%;
                    justify-content: space-between;
                    border-top: 1px solid rgba(0, 0, 0, 0.05);
                    padding-top: 10px;
                }

                #exams-list-modal .modal-header {
                    flex-direction: column !important;
                    align-items: flex-start !important;
                    gap: 15px !important;
                    padding: 20px 15px !important;
                }

                #exams-list-modal .modal-header>div:last-child {
                    width: 100%;
                    justify-content: space-between;
                    display: flex;
                }

                #exams-list-modal #exam-filter {
                    flex: 1;
                    max-width: 200px;
                }

                #exams-modal-container {
                    padding: 15px !important;
                }

                .exam-card {
                    padding: 15px !important;
                }

                .exam-card-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 10px;
                }

                /* Fix for overflowing teacher groups and sections */
                .admin-container {
                    padding: 10px !important;
                }

                .section {
                    padding: 15px !important;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    overflow: hidden;
                    /* Contain children */
                }

                .exam-grid {
                    grid-template-columns: 1fr !important;
                    width: 100%;
                }

                .collapsible-group {
                    width: 100%;
                    max-width: 100%;
                }

                /* Ensure responsive headers fit within narrower padding */
                .responsive-header {
                    padding: 10px !important;
                }
            }
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Mobile Menu Overlay -->
        <div id="mobile-menu-overlay" class="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="mobile-menu mobile-only">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; font-size: 1.2rem; color: var(--text-color);">üì± Menu</h2>
                <button class="close-btn" onclick="toggleMobileMenu()"
                    style="background: none; border: none; font-size: 1.8rem;">&times;</button>
            </div>

            <!-- Mini Stats in Menu -->
            <div class="mobile-stats-compact">
                <div class="stat-card-mini">
                    <h4>Teachers</h4>
                    <div class="val" id="stat-teachers-m">0</div>
                </div>
                <div class="stat-card-mini">
                    <h4>Exams</h4>
                    <div class="val" id="stat-exams-m">0</div>
                </div>
                <div class="stat-card-mini">
                    <h4>Active</h4>
                    <div class="val" id="stat-active-m">0</div>
                </div>
                <div class="stat-card-mini">
                    <h4>Students</h4>
                    <div class="val" id="stat-students-m">0</div>
                </div>
            </div>

            <div class="dropdown-divider"></div>

            <!-- Credentials & Theme in Menu -->
            <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
                <button class="btn btn-outline" onclick="toggleTheme()"
                    style="display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;">
                    üåì Toggle Theme
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="toggleMobileMenu(); openChangeUsernameModal();">
                    üÜî Change Username
                </button>
                <button class="dropdown-item" onclick="toggleMobileMenu(); openChangePasswordModal();">
                    üîë Change Password
                </button>
                <button class="dropdown-item danger" onclick="toggleMobileMenu(); handleLogout();"
                    style="margin-top: 10px; border: 1px solid var(--accent-color); border-radius: 8px;">
                    üö™ Logout Account
                </button>
            </div>
        </div>

        <!-- Header -->
        <div class="admin-header">
            <div style="display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div>
                        <h1 id="admin-name" style="margin: 0; font-size: 1.8rem; letter-spacing: -0.5px;">üë§ Admin</h1>
                        <p class="desktop-only" style="margin: 0; opacity: 0.8; font-size: 0.9rem; margin-top: 2px;">üõ°Ô∏è
                            Dashboard</p>
                    </div>

                    <!-- Desktop Header Actions -->
                    <div class="desktop-only" style="display: flex; gap: 12px; align-items: center;">
                        <button class="theme-toggle" onclick="toggleTheme()"
                            style="position: static; transform: none; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); border-radius: 8px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">üåì</button>

                        <div class="credentials-dropdown">
                            <button id="credentials-btn" class="dropdown-btn" onclick="toggleCredentialsDropdown()">
                                <span id="nav-user-display">üë§ Account</span>
                                <span style="font-size: 0.7rem; opacity: 0.8;">‚ñº</span>
                            </button>
                            <div id="credentials-dropdown-content" class="dropdown-content">
                                <div
                                    style="padding: 10px 18px; font-size: 0.7rem; color: var(--light-text); text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">
                                    Admin Settings</div>
                                <button class="dropdown-item" onclick="openChangeUsernameModal()">
                                    <span>üÜî Change Username</span>
                                </button>
                                <button class="dropdown-item" onclick="openChangePasswordModal()">
                                    <span>üîë Change Password</span>
                                </button>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item danger" onclick="handleLogout()">
                                    <span>üö™ Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Menu Trigger -->
                    <button class="hamburger-btn mobile-only" onclick="toggleMobileMenu()">
                        ‚ò∞
                    </button>
                </div>

                <!-- Header Loader (Mobile Only) -->
                <div class="mobile-only header-loader-mobile">
                    <input type="text" id="school-id-input-m" class="form-control" placeholder="School ID (e.g. SEATOS)"
                        style="flex: 1; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white;">
                    <button class="btn btn-primary" onclick="handleLoadSchool('m')" id="load-school-btn-m"
                        style="background: white; color: var(--primary-color);">
                        üîç Load
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Controls (Desktop) -->
        <div class="admin-controls desktop-only">
            <div class="control-group">
                <label for="school-id-input">School ID</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="school-id-input" class="form-control"
                        placeholder="Enter your school ID (e.g. SEATOS2026)" style="flex: 1;">
                    <button class="btn btn-primary" onclick="handleLoadSchool()" id="load-school-btn">
                        üîç Load
                    </button>
                </div>
                <small style="color: var(--light-text); margin-top: 5px; display: block;">
                    Enter your school ID to view teachers and exams.
                </small>
            </div>
        </div>

        <!-- Statistics (Desktop) -->
        <div class="stats-grid desktop-only">
            <div class="stat-card">
                <h3>Total Teachers</h3>
                <p class="value" id="stat-teachers">0</p>
            </div>
            <div class="stat-card">
                <h3>Total Exams</h3>
                <p class="value" id="stat-exams">0</p>
            </div>
            <div class="stat-card">
                <h3>Active Exams</h3>
                <p class="value" id="stat-active">0</p>
            </div>
            <div class="stat-card">
                <h3>Total Students</h3>
                <p class="value" id="stat-students">0</p>
            </div>
        </div>

        <!-- All Exams Section -->
        <div class="section">
            <div class="section-header responsive-header" onclick="openExamsModal('all')"
                style="cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'"
                onmouseout="this.style.opacity='1'">
                <div class="header-main">
                    <h2>üìö All Exams</h2>
                    <span class="badge badge-primary">View All</span>
                </div>
                <div class="header-action">Click to see all exams ‚ûî</div>
            </div>
            <div id="exams-teacher-list" class="exam-grid">
                <!-- Teacher list summary will be here -->
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p>Select a school version to view exams</p>
                </div>
            </div>
        </div>

        <!-- Messaging Section -->
        <div class="section">
            <div class="section-header">
                <h2>üí¨ Teacher Messaging</h2>
            </div>
            <div class="messaging-section">
                <div class="message-form">
                    <div class="control-group">
                        <label for="teacher-select">Select Teacher</label>
                        <select id="teacher-select">
                            <option value="">Choose a teacher...</option>
                            <option value="ALL_TEACHERS" style="font-weight: bold; color: var(--primary-color);">üì¢ All
                                Teachers (Bulk Message)</option>
                        </select>
                        <small id="teacher-count-hint"
                            style="color: var(--light-text); font-size: 0.8rem; margin-top: 5px; display: none;">
                            This will send to all teachers in your school.
                        </small>
                    </div>
                    <div class="control-group">
                        <label for="message-text">Message</label>
                        <textarea id="message-text" placeholder="Type your message here..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="sendMessage()" id="send-btn">
                        üì§ Send Message
                    </button>
                </div>
                <div class="message-history">
                    <h3 style="margin-top: 0; margin-bottom: 15px;">Message History</h3>
                    <div id="message-history-container">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>No messages sent yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Theme Toggle Button -->
        <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåô</button>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal" style="display: none; z-index: 4000;">
        <div class="modal-content"
            style="max-width: 400px; margin: 10vh auto; width: 92%; padding: 0; overflow: hidden; border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header"
                style="background: var(--primary-color); color: white; padding: 20px; margin-bottom: 0; border: none;">
                <h3 style="margin: 0; color: white;">üîë Change Password</h3>
                <span class="close-btn" onclick="closeChangePasswordModal()"
                    style="color: white; opacity: 0.8;">&times;</span>
            </div>
            <div style="padding: 24px; background: var(--card-bg);">
                <p style="font-size: 0.9rem; color: var(--light-text); margin-bottom: 24px;">
                    Enter your current password and a new secure password.
                </p>

                <div class="control-group" style="margin-bottom: 20px;">
                    <label
                        style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 8px;">Current
                        Password</label>
                    <div style="position: relative;">
                        <input type="password" id="current-password" class="form-control"
                            autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" onclick="togglePasswordVisibility('current-password', this)"
                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.6;">üëÅÔ∏è</button>
                    </div>
                </div>

                <div class="control-group" style="margin-bottom: 20px;">
                    <label style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 8px;">New
                        Password</label>
                    <div style="position: relative;">
                        <input type="password" id="new-password" class="form-control" autocomplete="new-password"
                            placeholder="At least 8 characters">
                        <button type="button" onclick="togglePasswordVisibility('new-password', this)"
                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.6;">üëÅÔ∏è</button>
                    </div>
                </div>

                <div class="control-group" style="margin-bottom: 24px;">
                    <label
                        style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 8px;">Confirm
                        New Password</label>
                    <input type="password" id="confirm-new-password" class="form-control" autocomplete="new-password"
                        placeholder="Repeat new password">
                </div>

                <div id="password-error"
                    style="color: var(--accent-color); font-size: 0.85rem; margin-top: -10px; margin-bottom: 15px; display: none; background: rgba(231, 76, 60, 0.1); padding: 10px; border-radius: 6px; border: 1px solid var(--accent-color);">
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 15px 24px; background: var(--inner-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; margin-top: 0;">
                <button class="btn"
                    style="background: transparent; border: 1px solid var(--border-color); color: var(--light-text);"
                    onclick="closeChangePasswordModal()">Cancel</button>
                <button id="submit-password-btn" class="btn btn-primary" onclick="submitPasswordChange()">Update
                    Password</button>
            </div>
        </div>
    </div>

    <!-- Change Username Modal -->
    <div id="change-username-modal" class="modal" style="display: none; z-index: 4000;">
        <div class="modal-content"
            style="max-width: 400px; margin: 10vh auto; width: 92%; padding: 0; overflow: hidden; border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header"
                style="background: var(--primary-color); color: white; padding: 20px; margin-bottom: 0; border: none;">
                <h3 style="margin: 0; color: white;">üÜî Change Username</h3>
                <span class="close-btn" onclick="closeChangeUsernameModal()"
                    style="color: white; opacity: 0.8;">&times;</span>
            </div>
            <div style="padding: 24px; background: var(--card-bg);">
                <p style="font-size: 0.9rem; color: var(--light-text); margin-bottom: 24px;">
                    Update your admin account identifier (username).
                </p>

                <div class="control-group" style="margin-bottom: 20px;">
                    <label style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 8px;">New
                        Username</label>
                    <input type="text" id="new-username" class="form-control" placeholder="e.g. admin_pro"
                        style="width: 100%; border-radius: 8px;">
                </div>


                <div id="username-success" style="color: #27ae60; font-size: 0.85rem; margin-top: 10px; display: none;">
                </div>
                <div id="username-error" style="color: #e74c3c; font-size: 0.85rem; margin-top: 10px; display: none;">
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 20px 24px; background: var(--inner-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; margin-top: 0;">
                <button class="btn btn-outline" onclick="closeChangeUsernameModal()"
                    style="padding: 10px 20px; border-radius: 8px;">Cancel</button>
                <button id="submit-username-btn" class="btn btn-primary" onclick="submitUsernameChange()"
                    style="padding: 10px 25px; border-radius: 8px; font-weight: 600;">Update Username</button>
            </div>
        </div>
    </div>

    <!-- Schedule & Duration Modal -->
    <div id="schedule-modal" class="modal" style="display: none; z-index: 4000;">
        <div class="modal-content"
            style="max-width: 420px; margin: 10vh auto; width: 92%; padding: 0; overflow: hidden; border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header"
                style="background: var(--primary-color); color: white; padding: 20px; margin-bottom: 0; border: none;">
                <h3 style="margin: 0; color: white;">üìÖ Schedule & Duration</h3>
                <span class="close-btn" onclick="closeScheduleModal()"
                    style="color: white; opacity: 0.8;">&times;</span>
            </div>
            <div style="padding: 24px; background: var(--card-bg);">
                <input type="hidden" id="schedule-exam-id">

                <div class="control-group" style="margin-bottom: 20px;">
                    <label style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 8px;">
                        ‚è±Ô∏è Exam Duration (minutes)</label>
                    <input type="number" id="schedule-duration" class="form-control" min="1" max="600"
                        placeholder="e.g. 30" style="width: 100%; border-radius: 8px;">
                    <small style="color: var(--light-text); font-size: 0.75rem;">Between 1 and 600 minutes</small>
                </div>

                <div class="control-group" style="margin-bottom: 20px;">
                    <label style="font-size: 0.85rem; color: var(--light-text); display: block; margin-bottom: 8px;">
                        üìÖ Scheduled Date & Time</label>
                    <input type="datetime-local" id="schedule-date" class="form-control"
                        style="width: 100%; border-radius: 8px;">
                    <small style="color: var(--light-text); font-size: 0.75rem;">Leave empty to make the exam
                        immediately available</small>
                </div>

                <div id="schedule-error" style="color: #e74c3c; font-size: 0.85rem; margin-top: 10px; display: none;">
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 20px 24px; background: var(--inner-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; margin-top: 0;">
                <button class="btn btn-outline" onclick="closeScheduleModal()"
                    style="padding: 10px 20px; border-radius: 8px;">Cancel</button>
                <button id="schedule-submit-btn" class="btn btn-primary" onclick="submitScheduleChanges()"
                    style="padding: 10px 25px; border-radius: 8px; font-weight: 600;">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="modal" style="display: none; z-index: 5000;">
        <div class="modal-content"
            style="max-width: 400px; margin: 30vh auto; width: 90%; padding: 0; overflow: hidden; border-radius: 12px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.4); text-align: center;">
            <div class="modal-header"
                style="background: var(--primary-color); color: white; padding: 15px; margin-bottom: 0; border: none; justify-content: center;">
                <h3 id="alert-title" style="margin: 0; color: white;">Notice</h3>
            </div>
            <div style="padding: 30px 20px; background: var(--card-bg);">
                <p id="alert-message" style="margin: 0; font-size: 1rem; line-height: 1.5; color: var(--text-color);">
                </p>
            </div>
            <div
                style="padding: 15px; background: var(--inner-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: center;">
                <button id="alert-ok-btn" class="btn btn-primary"
                    style="padding: 8px 30px; min-width: 100px;">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal" style="display: none; z-index: 5000;">
        <div class="modal-content"
            style="max-width: 400px; margin: 30vh auto; width: 90%; padding: 0; overflow: hidden; border-radius: 12px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.4); text-align: center;">
            <div class="modal-header"
                style="background: #e67e22; color: white; padding: 15px; margin-bottom: 0; border: none; justify-content: center;">
                <h3 id="confirm-title" style="margin: 0; color: white;">Confirm Action</h3>
            </div>
            <div style="padding: 30px 20px; background: var(--card-bg);">
                <p id="confirm-message" style="margin: 0; font-size: 1rem; line-height: 1.5; color: var(--text-color);">
                </p>
            </div>
            <div
                style="padding: 15px; background: var(--inner-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: center; gap: 15px;">
                <button id="confirm-no-btn" class="btn btn-secondary"
                    style="padding: 8px 25px; min-width: 100px; background: #95a5a6;">Cancel</button>
                <button id="confirm-yes-btn" class="btn btn-primary"
                    style="padding: 8px 25px; min-width: 100px; background: #e67e22;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Exams List Modal -->
    <div id="exams-list-modal" class="modal" style="display: none; z-index: 3000;">
        <div class="modal-content"
            style="max-width: 900px; margin: 5vh auto; width: 95%; height: 90vh; padding: 0; overflow: hidden; border-radius: 12px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.4); display: flex; flex-direction: column;">
            <div class="modal-header"
                style="background: var(--primary-color); color: white; padding: 15px 25px; margin-bottom: 0; border: none; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 id="exams-modal-title" style="margin: 0; color: white;">üìö Exam List</h3>
                    <p id="exams-modal-subtitle" style="margin: 0; font-size: 0.8rem; opacity: 0.8;"></p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <select id="exam-filter" onchange="filterExams()"
                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; cursor: pointer; font-size: 0.85rem; outline: none;">
                        <option value="all">All Status</option>
                        <option value="active">‚úÖ Active Only</option>
                        <option value="draft">üìù Drafts Only</option>
                        <option value="archived">üì¶ Archived Only</option>
                    </select>
                    <span class="close-btn" onclick="closeExamsModal()"
                        style="color: white; opacity: 0.8; font-size: 2rem; cursor: pointer;">&times;</span>
                </div>
            </div>
            <div id="exams-modal-container"
                style="padding: 25px; overflow-y: auto; flex: 1; background: var(--card-bg);">
                <!-- Exams will be rendered here -->
            </div>
            <div class="modal-footer"
                style="padding: 15px 25px; background: var(--inner-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; flex-shrink: 0;">
                <button class="btn btn-primary" onclick="closeExamsModal()" style="padding: 8px 25px;">Close</button>
            </div>
        </div>
    </div>

    <!-- PocketBase SDK -->
    <script src="https://unpkg.com/pocketbase@0.21.0/dist/pocketbase.umd.js"></script>

    <!-- Configuration System -->
    <script type="module">
        import { initConfig } from '../config/index.js';
        await initConfig();
    </script>

    <!-- Scripts -->
    <script src="../js/utils.js"></script>
    <script src="../js/dataService.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        let currentUser = null;
        let allTeachers = [];
        let allExams = [];
        let allStudents = [];
        let messageHistory = [];
        let currentVersion = '';

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }

        // Mobile Menu Toggle
        window.toggleMobileMenu = function () {
            const menu = document.getElementById('mobile-menu');
            const overlay = document.getElementById('mobile-menu-overlay');
            if (menu && overlay) {
                const isActive = menu.classList.contains('active');
                if (isActive) {
                    menu.classList.remove('active');
                    overlay.classList.remove('active');
                } else {
                    menu.classList.add('active');
                    overlay.classList.add('active');
                }
            }
        }

        // Synchronize School Loaders
        window.handleLoadSchool = async function (source) {
            const inputId = source === 'm' ? 'school-id-input-m' : 'school-id-input';
            const loadBtnId = source === 'm' ? 'load-school-btn-m' : 'load-school-btn';
            const input = document.getElementById(inputId);
            const loadBtn = document.getElementById(loadBtnId);
            const schoolId = input.value.trim();

            if (!schoolId) {
                showAlert('Missing Info', 'Please enter a School ID');
                return;
            }

            // Sync other input
            const otherId = source === 'm' ? 'school-id-input' : 'school-id-input-m';
            const otherEl = document.getElementById(otherId);
            if (otherEl) otherEl.value = schoolId;

            currentVersion = schoolId;
            if (loadBtn) {
                loadBtn.disabled = true;
                loadBtn.textContent = 'Loading...';
            }

            try {
                await loadData();
                // Save the school ID for next time
                if (currentUser) {
                    currentUser.schoolVersion = schoolId;
                    localStorage.setItem('cbt_user_meta', JSON.stringify(currentUser));
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error', 'Failed to load data: ' + error.message);
            } finally {
                if (loadBtn) {
                    loadBtn.disabled = false;
                    loadBtn.textContent = 'üîç Load';
                }
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Initialize theme immediately
        initTheme();

        // Initialize
        async function init() {
            currentUser = dataService.getCurrentUser();

            if (!currentUser || currentUser.role !== 'admin') {
                await showAlert('Access Denied', 'üõ°Ô∏è Admin privileges required to access this area.');
                window.location.href = '../index.html';
                return;
            }

            document.getElementById('admin-name').textContent = `üë§ ${currentUser.name || 'Admin'}`;
            const navDisplay = document.getElementById('nav-user-display');
            if (navDisplay) navDisplay.textContent = `üë§ ${currentUser.username || 'Account'}`;

            // Resolve Admin Profile ID
            if (!currentUser.profileId) {
                try {
                    // Try to finding existing profile
                    const profile = await dataService.pb.collection('profiles').getFirstListItem(`user="${currentUser.id}"`);
                    if (profile) {
                        currentUser.profileId = profile.id;
                        localStorage.setItem('cbt_user_meta', JSON.stringify(currentUser));
                    }
                } catch (e) {
                    // Create if missing
                    try {
                        const newProfile = await dataService.pb.collection('profiles').create({
                            user: currentUser.id,
                            full_name: currentUser.name || 'Admin',
                            role: 'admin',
                            school_version: currentUser.schoolVersion || ''
                        });
                        currentUser.profileId = newProfile.id;
                        localStorage.setItem('cbt_user_meta', JSON.stringify(currentUser));
                        console.log('‚úÖ Created Admin Profile:', newProfile.id);
                    } catch (createErr) {
                        console.error('Failed to resolve/create admin profile:', createErr);
                    }
                }
            }


            // Pre-fill the school ID if admin has one saved
            if (currentUser.schoolVersion) {
                document.getElementById('school-id-input').value = currentUser.schoolVersion;
                currentVersion = currentUser.schoolVersion;
                await loadData();
            }

            // Load message history
            await loadMessageHistory();

            // Setup teacher select listener
            document.getElementById('teacher-select').addEventListener('change', (e) => {
                const hint = document.getElementById('teacher-count-hint');
                if (e.target.value === 'ALL_TEACHERS') {
                    hint.textContent = `This will send to all ${allTeachers.length} teachers in ${currentVersion}.`;
                    hint.style.display = 'block';
                } else {
                    hint.style.display = 'none';
                }
            });

            // Allow pressing Enter to load (Desktop)
            document.getElementById('school-id-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLoadSchool();
                }
            });

            // Allow pressing Enter to load (Mobile)
            document.getElementById('school-id-input-m').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLoadSchool('m');
                }
            });
        }




        async function loadData() {
            try {
                // Load only teachers and students for this version
                // This is more efficient than loading all users and filtering locally
                const teachersResult = await dataService.getUsers({
                    role: 'teacher',
                    schoolVersion: currentVersion
                });

                allTeachers = teachersResult;

                // For students, we might still want all or filter by school if applicable
                // For now, let's keep all students or filter if needed
                allStudents = await dataService.getUsers({ role: 'student' });

                // Populate teacher dropdown
                const teacherSelect = document.getElementById('teacher-select');
                const currentSelected = teacherSelect.value;

                teacherSelect.innerHTML = `
                    <option value="">Choose a teacher...</option>
                    <option value="ALL_TEACHERS" style="font-weight: bold;">üì¢ All Teachers (${allTeachers.length})</option>
                `;
                allTeachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.full_name || teacher.username;
                    teacherSelect.appendChild(option);
                });

                // Restore selection if teacher still exists
                if (currentSelected && allTeachers.some(t => t.id === currentSelected)) {
                    teacherSelect.value = currentSelected;
                } else if (currentSelected === 'ALL_TEACHERS') {
                    teacherSelect.value = 'ALL_TEACHERS';
                }

                // Load all exams
                allExams = await dataService.getExams();

                // Filter exams by teachers in this version
                // Match by either profile ID or user ID since createdBy might store either
                const teacherIds = allTeachers.map(t => t.id);
                const teacherUserIds = allTeachers.map(t => t.user).filter(id => !!id);

                allExams = allExams.filter(exam =>
                    teacherIds.includes(exam.createdBy) ||
                    teacherUserIds.includes(exam.createdBy)
                );


                // Update stats
                const activeExams = allExams.filter(e => e.status === 'active').length;
                updateStats(allTeachers.length, allExams.length, activeExams, allStudents.length);

                // Display exams
                displayExams(allExams);

                // Setup real-time subscription for TEACHER RECOGNITION
                setupRealTimeUpdates();

            } catch (error) {
                console.error('Error loading data:', error);
                // alert('Failed to load data: ' + error.message);
            }
        }

        let isSubscribed = false;
        async function setupRealTimeUpdates() {
            if (isSubscribed) return;

            try {
                await dataService.subscribeToProfiles(async (e) => {
                    console.log('üîî Real-time profile update:', e.action, e.record);

                    const profile = e.record;
                    // Case-insensitive comparison and handling potential missing school_version
                    const schoolMatch = profile.school_version &&
                        currentVersion &&
                        profile.school_version.trim().toLowerCase() === currentVersion.trim().toLowerCase();

                    const roleMatch = profile.role === 'teacher';
                    const isRelevant = roleMatch && schoolMatch;

                    // Check if this teacher WAS in our list (for departures)
                    const wasInList = allTeachers.some(t => t.id === profile.id || (t.user === profile.user && !!profile.user));

                    if (isRelevant || (e.action === 'update' && wasInList)) {
                        console.log('üîÑ Refreshing teacher list due to real-time update');
                        // Refresh data to update UI and stats
                        await loadData();

                        // Show a small notification for additions
                        if (isRelevant && (e.action === 'create' || !wasInList)) {
                            showToast(`Teacher Recognized: ${profile.full_name || 'New Teacher'}`);
                        }
                    } else {
                        console.log('Skipping update: Not relevant to current school version');
                    }
                });

                isSubscribed = true;
            } catch (err) {
                console.warn('Real-time subscription failed:', err);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = 'position: fixed; bottom: 80px; left: 20px; background: var(--primary-color); color: white; padding: 12px 20px; border-radius: 8px; z-index: 9999; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s;';
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }


        function updateStats(teachers, exams, active, students) {
            // Update Desktop Stats
            const dTeachers = document.getElementById('stat-teachers');
            if (dTeachers) dTeachers.textContent = teachers;
            const dExams = document.getElementById('stat-exams');
            if (dExams) dExams.textContent = exams;
            const dActive = document.getElementById('stat-active');
            if (dActive) dActive.textContent = active;
            const dStudents = document.getElementById('stat-students');
            if (dStudents) dStudents.textContent = students;

            // Update Mobile Stats
            document.getElementById('stat-teachers-m').textContent = teachers;
            document.getElementById('stat-exams-m').textContent = exams;
            document.getElementById('stat-active-m').textContent = active;
            document.getElementById('stat-students-m').textContent = students;
        }

        // Global state for current view in modal
        let currentModalTeacherId = 'all';

        function displayExams(exams) {
            const container = document.getElementById('exams-teacher-list');

            if (exams.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No exams found</p>
                    </div>
                `;
                return;
            }

            // Group exams by teacher to show teacher summaries
            const groupedExams = {};
            exams.forEach(exam => {
                const teacher = allTeachers.find(t => t.id === exam.createdBy || t.user === exam.createdBy);
                const teacherName = teacher ? (teacher.full_name || teacher.username || 'Teacher') : 'Unknown Teacher';
                const teacherId = teacher ? teacher.id : 'unknown';

                if (!groupedExams[teacherId]) {
                    groupedExams[teacherId] = {
                        id: teacherId,
                        name: teacherName,
                        count: 0
                    };
                }
                groupedExams[teacherId].count++;
            });

            container.innerHTML = Object.values(groupedExams).map(group => `
                <div class="collapsible-group" style="cursor: pointer; transition: all 0.2s; border-radius: 8px;" 
                     onclick="openExamsModal('${group.id}')"
                     onmouseover="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" 
                     onmouseout="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    <div class="collapsible-header responsive-header" style="background: var(--inner-bg); border: none;">
                        <h3 class="header-title">üë®‚Äçüè´ ${group.name}</h3>
                        <div class="header-sub">
                            <span class="group-count">${group.count} ${group.count === 1 ? 'Exam' : 'Exams'}</span>
                            <span class="view-link">View ‚ûî</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.openExamsModal = function (teacherId) {
            currentModalTeacherId = teacherId;
            const modal = document.getElementById('exams-list-modal');
            const titleEl = document.getElementById('exams-modal-title');
            const subtitleEl = document.getElementById('exams-modal-subtitle');

            // Set title based on selection
            if (teacherId === 'all') {
                titleEl.textContent = 'üìö All School Exams';
                subtitleEl.textContent = `Viewing all exams for version: ${currentVersion}`;
            } else {
                const teacher = allTeachers.find(t => t.id === teacherId);
                const teacherName = teacher ? (teacher.full_name || teacher.username) : 'Teacher';
                titleEl.textContent = `üë®‚Äçüè´ Exams by ${teacherName}`;
                subtitleEl.textContent = `Exams published in ${currentVersion}`;
            }

            // Reset filter to 'all' when opening
            document.getElementById('exam-filter').value = 'all';

            modal.style.display = 'flex';
            filterExams(); // Initial render in modal
        };

        window.closeExamsModal = function () {
            document.getElementById('exams-list-modal').style.display = 'none';
        };

        window.filterExams = function () {
            const statusFilter = document.getElementById('exam-filter').value;

            let filtered = allExams;

            // First filter by teacher if necessary
            if (currentModalTeacherId !== 'all') {
                filtered = filtered.filter(e => {
                    const teacher = allTeachers.find(t => t.id === e.createdBy || t.user === e.createdBy);
                    return teacher && teacher.id === currentModalTeacherId;
                });
            }

            // Then filter by status
            if (statusFilter !== 'all') {
                filtered = filtered.filter(e => e.status === statusFilter);
            }

            displayExamsInModal(filtered);
        };

        function displayExamsInModal(exams) {
            const container = document.getElementById('exams-modal-container');

            if (exams.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No exams match the current filters</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    ${exams.map(exam => {
                const teacher = allTeachers.find(t => t.id === exam.createdBy || t.user === exam.createdBy);
                const teacherName = teacher ? (teacher.full_name || teacher.username || 'Teacher') : 'Unknown Teacher';

                let statusClass = 'status-draft';
                if (exam.status === 'active') statusClass = 'status-active';
                if (exam.status === 'archived') statusClass = 'status-archived';

                const scheduledInfo = exam.scheduledDate
                    ? `<span>üìÖ ${new Date(exam.scheduledDate).toLocaleString()}</span>`
                    : '';

                return `
                            <div class="exam-card" id="exam-card-${exam.id}">
                                <div class="exam-card-header">
                                    <div>
                                        <h3 class="exam-title">${exam.title}</h3>
                                        <div class="exam-meta">
                                            <span>üë®‚Äçüè´ ${teacherName}</span>
                                            <span>üìö ${exam.subject}</span>
                                            <span>üéØ ${exam.targetClass}</span>
                                            <span>‚è±Ô∏è ${exam.duration} min</span>
                                            <span>‚ùì ${exam.questions.length} questions</span>
                                            ${scheduledInfo}
                                        </div>
                                    </div>
                                    <span class="status-badge ${statusClass}">${exam.status}</span>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    <select id="status-${exam.id}" onchange="changeExamStatus('${exam.id}', this.value)" 
                                        style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.85rem; cursor: pointer; background: var(--card-bg); color: var(--text-color);">
                                        <option value="active" ${exam.status === 'active' ? 'selected' : ''}>‚úÖ Active</option>
                                        <option value="draft" ${exam.status === 'draft' ? 'selected' : ''}>üìù Draft</option>
                                        <option value="archived" ${exam.status === 'archived' ? 'selected' : ''}>üì¶ Archived</option>
                                    </select>
                                    <select id="class-${exam.id}" onchange="changeExamClass('${exam.id}', this.value)"
                                        style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.85rem; cursor: pointer; background: var(--card-bg); color: var(--text-color);">
                                        <option value="All" ${exam.targetClass === 'All' ? 'selected' : ''}>üéØ All Classes</option>
                                        ${getClassOptions(exam.targetClass)}
                                    </select>
                                    <button onclick="openScheduleModal('${exam.id}', ${exam.duration}, '${exam.scheduledDate || ''}')" 
                                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--inner-bg); color: var(--text-color); cursor: pointer; font-size: 0.85rem;">
                                        üìÖ Schedule
                                    </button>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        // Generate class options for the dropdown
        function getClassOptions(currentClass) {
            const classes = [
                'JSS 1', 'JSS 2', 'JSS 3',
                'SS 1', 'SS 2', 'SS 3',
                'Primary 1', 'Primary 2', 'Primary 3',
                'Primary 4', 'Primary 5', 'Primary 6',
                'Grade 1', 'Grade 2', 'Grade 3',
                'Grade 4', 'Grade 5', 'Grade 6',
                'Grade 7', 'Grade 8', 'Grade 9',
                'Grade 10', 'Grade 11', 'Grade 12'
            ];
            return classes.map(c =>
                `<option value="${c}" ${currentClass === c ? 'selected' : ''}>${c}</option>`
            ).join('');
        }

        // Admin: Change exam status (active/draft/archived)
        async function changeExamStatus(examId, newStatus) {
            try {
                await dataService.updateExam(examId, { status: newStatus });
                // Update local data
                const exam = allExams.find(e => e.id === examId);
                if (exam) exam.status = newStatus;

                // Update stats
                const activeExams = allExams.filter(e => e.status === 'active').length;
                updateStats(allTeachers.length, allExams.length, activeExams, allStudents.length);

                showToast(`Exam status changed to "${newStatus}"`);

                // If a modal is open, refresh the modal view too
                if (document.getElementById('exams-list-modal').style.display === 'flex') {
                    filterExams();
                }

                displayExams(allExams); // Refresh main summary list
            } catch (err) {
                console.error('Failed to change exam status:', err);
                showAlert('Error', 'Failed to change exam status: ' + err.message);
            }
        }

        // Admin: Change exam target class
        async function changeExamClass(examId, newClass) {
            try {
                await dataService.updateExam(examId, { targetClass: newClass });
                // Update local data
                const exam = allExams.find(e => e.id === examId);
                if (exam) exam.targetClass = newClass;

                showToast(`Exam class changed to "${newClass}"`);
                // If a modal is open, refresh the modal view too
                if (document.getElementById('exams-list-modal').style.display === 'flex') {
                    filterExams();
                }
            } catch (err) {
                console.error('Failed to change exam class:', err);
                showAlert('Error', 'Failed to change exam class: ' + err.message);
            }
        }

        // Admin: Open schedule/duration modal
        function openScheduleModal(examId, currentDuration, currentSchedule) {
            const modal = document.getElementById('schedule-modal');
            document.getElementById('schedule-exam-id').value = examId;
            document.getElementById('schedule-duration').value = currentDuration || 30;

            const dateInput = document.getElementById('schedule-date');
            if (currentSchedule && currentSchedule !== 'undefined' && currentSchedule !== '') {
                try {
                    // Convert to local datetime format for the input
                    const d = new Date(currentSchedule);
                    if (!isNaN(d.getTime())) {
                        dateInput.value = d.toISOString().slice(0, 16);
                    } else {
                        dateInput.value = '';
                    }
                } catch (e) {
                    dateInput.value = '';
                }
            } else {
                dateInput.value = '';
            }

            document.getElementById('schedule-error').style.display = 'none';
            modal.style.display = 'flex';
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').style.display = 'none';
        }

        async function submitScheduleChanges() {
            const examId = document.getElementById('schedule-exam-id').value;
            const durationVal = document.getElementById('schedule-duration').value;
            const dateVal = document.getElementById('schedule-date').value;
            const errorEl = document.getElementById('schedule-error');
            const submitBtn = document.getElementById('schedule-submit-btn');

            const duration = parseInt(durationVal);
            if (isNaN(duration) || duration < 1 || duration > 600) {
                errorEl.textContent = 'Duration must be between 1 and 600 minutes.';
                errorEl.style.display = 'block';
                return;
            }

            let scheduledDate = '';
            if (dateVal.trim()) {
                const d = new Date(dateVal.trim());
                if (isNaN(d.getTime())) {
                    errorEl.textContent = 'Invalid date/time. Please use the date picker.';
                    errorEl.style.display = 'block';
                    return;
                }
                scheduledDate = d.toISOString();
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                errorEl.style.display = 'none';

                await dataService.updateExam(examId, {
                    duration: duration,
                    scheduledDate: scheduledDate
                });

                // Update local data
                const exam = allExams.find(e => e.id === examId);
                if (exam) {
                    exam.duration = duration;
                    exam.scheduledDate = scheduledDate;
                }

                const msg = scheduledDate
                    ? `Updated: ${duration} min, scheduled for ${new Date(scheduledDate).toLocaleString()}`
                    : `Updated: ${duration} min, available immediately`;
                showToast(msg);

                // If a modal is open, refresh the modal view too
                if (document.getElementById('exams-list-modal').style.display === 'flex') {
                    filterExams();
                }

                displayExams(allExams);
                closeScheduleModal();
            } catch (err) {
                console.error('Failed to update schedule:', err);
                errorEl.textContent = 'Failed to update: ' + err.message;
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        }

        async function sendMessage() {
            const teacherSelect = document.getElementById('teacher-select');
            const messageText = document.getElementById('message-text');
            const sendBtn = document.getElementById('send-btn');

            const teacherId = teacherSelect.value;
            const message = messageText.value.trim();

            if (!teacherId) {
                showAlert('Missing Info', 'Please select a teacher');
                return;
            }

            if (!message) {
                showAlert('Empty Message', 'Please enter a message');
                return;
            }

            sendBtn.disabled = true;

            try {
                // Handle bulk messaging to all teachers
                if (teacherId === 'ALL_TEACHERS') {
                    if (allTeachers.length === 0) {
                        showAlert('Error', 'No teachers loaded. Please load a school first.');
                        return;
                    }

                    const confirmBulk = await showConfirm('‚ö†Ô∏è Bulk Message', `Send this message to ALL ${allTeachers.length} teachers in ${currentVersion}?`);
                    if (!confirmBulk) {
                        sendBtn.disabled = false;
                        return;
                    }

                    sendBtn.textContent = `Sending to ${allTeachers.length} teachers...`;

                    let successCount = 0;
                    let failCount = 0;

                    // Send to each teacher
                    for (let i = 0; i < allTeachers.length; i++) {
                        const teacher = allTeachers[i];
                        const targetUserId = teacher.user || teacher.id; // Fallback only if user is missing

                        sendBtn.textContent = `Sending... ${i + 1}/${allTeachers.length}`;

                        try {
                            await dataService.sendMessage({
                                fromId: currentUser.id,
                                toId: targetUserId,
                                message: message,
                                schoolVersion: currentVersion
                            });
                            successCount++;

                            // Add to local history for display
                            const messageObj = {
                                id: Date.now() + i, // Fake ID for UI
                                from: currentUser.name,
                                fromId: currentUser.id,
                                to: teacher.full_name || 'Teacher',
                                toId: targetUserId,
                                message: message,
                                timestamp: new Date().toISOString(),
                                schoolVersion: currentVersion
                            };
                            messageHistory.push(messageObj);

                        } catch (err) {

                            console.error(`Failed to send to ${teacher.full_name}:`, err);
                            failCount++;
                        }
                    }

                    // Show results
                    if (failCount === 0) {
                        showAlert('Success', `‚úÖ Message sent to all ${successCount} teachers!`);
                    } else {
                        showAlert('Partial Success', `Sent to ${successCount} teachers. Failed: ${failCount}`);
                    }

                    // Update History UI
                    displayMessageHistory();

                } else {
                    // Single teacher message
                    sendBtn.textContent = 'Sending...';
                    const teacher = allTeachers.find(t => t.id === teacherId);
                    const targetUserId = teacher?.user || teacherId;

                    const messageData = {
                        fromId: currentUser.id,
                        toId: targetUserId,
                        message: message,
                        schoolVersion: currentVersion
                    };


                    try {
                        console.log('Sending message payload:', messageData);
                        const createdMsg = await dataService.sendMessage(messageData);
                        showAlert('Message Sent', `Message sent to ${teacher?.full_name || 'teacher'}!`);

                        // Add to history
                        const messageObj = {
                            id: createdMsg?.id || Date.now(),
                            from: currentUser.name,
                            fromId: currentUser.profileId || currentUser.id,
                            to: teacher?.full_name || 'Teacher',
                            toId: teacherId,
                            message: message,
                            timestamp: new Date().toISOString(),
                            schoolVersion: currentVersion
                        };
                        messageHistory.push(messageObj);

                        // Re-sort and Display History
                        displayMessageHistory();

                    } catch (dbError) {
                        console.error('Full Database Error:', dbError);
                        if (dbError.data) console.error('Validation Errors:', dbError.data);

                        console.warn('Database save failed, using localStorage:', dbError);
                        const messageObj = {
                            id: Date.now(),
                            from: currentUser.name,
                            fromId: currentUser.id,
                            to: teacher?.full_name || 'Unknown',
                            toId: teacherId,
                            message: message,
                            timestamp: new Date().toISOString(),
                            schoolVersion: currentVersion
                        };
                        messageHistory.push(messageObj);
                        localStorage.setItem('admin_messages', JSON.stringify(messageHistory)); // Backup
                        displayMessageHistory(); // Update UI

                        showAlert('Saved Offline', `Message sent! (Saved locally)`);
                    }
                }

                // Clear form
                messageText.value = '';
                teacherSelect.value = '';
                document.getElementById('teacher-count-hint').style.display = 'none';

            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Error', 'Failed to send message: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'üì§ Send Message';
            }
        }


        async function loadMessageHistory() {
            try {
                // Fetch both sent and received messages
                const userId = currentUser.id;

                // Fetch messages SENT BY admin
                const sentMessages = await dataService.getMessages({
                    fromId: userId,
                    schoolVersion: currentVersion
                });

                // Fetch messages SENT TO admin
                const receivedMessages = await dataService.getMessages({
                    toId: userId,
                    schoolVersion: currentVersion
                });

                // Map and combine
                const mappedSent = sentMessages.map(msg => ({
                    id: msg.id,
                    from: 'Me',
                    fromId: userId,
                    to: msg.expand?.to_id?.full_name || 'Teacher',
                    toId: msg.to_id,
                    message: msg.message,
                    timestamp: msg.created_at,
                    schoolVersion: msg.school_version,
                    isSent: true
                }));

                const mappedReceived = receivedMessages.map(msg => ({
                    id: msg.id,
                    from: msg.expand?.from_id?.full_name || 'User',
                    fromId: msg.from_id,
                    to: 'Me',
                    toId: userId,
                    message: msg.message,
                    timestamp: msg.created_at,
                    schoolVersion: msg.school_version,
                    isSent: false
                }));

                const mappedDbMessages = [...mappedSent, ...mappedReceived];


                // Merge with local storage (failed sends)
                const stored = localStorage.getItem('admin_messages');
                let localMessages = [];
                if (stored) {
                    try {
                        localMessages = JSON.parse(stored);
                    } catch (e) {
                        console.warn('Bad local message history', e);
                    }
                }

                // Keep local messages that are NOT in DB (by ID check or if ID is numeric/timestamp)
                // DB IDs are strings, Local IDs are numbers (timestamps) or matching strings if they were saved?
                // Actually, if we saved locally AFTER DB failure, it has a numeric ID.
                const dbIds = new Set(mappedDbMessages.map(m => m.id));
                const uniqueLocal = localMessages.filter(m => !dbIds.has(m.id) && typeof m.id === 'number');

                messageHistory = [...mappedDbMessages, ...uniqueLocal];

                displayMessageHistory();
            } catch (error) {
                console.warn('Failed to load messages from database, using localStorage:', error);
                // Fallback to localStorage
                const stored = localStorage.getItem('admin_messages');
                if (stored) {
                    messageHistory = JSON.parse(stored);
                    displayMessageHistory();
                }
            }
        }


        function displayMessageHistory() {
            const container = document.getElementById('message-history-container');

            // Filter messages for current version
            const versionMessages = messageHistory.filter(m => m.schoolVersion === currentVersion);

            if (versionMessages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <p>No messages sent yet</p>
                    </div>
                `;
                return;
            }

            // Group messages by contact
            const groupedMessages = {};
            versionMessages.forEach(msg => {
                const contactId = msg.isSent ? msg.toId : msg.fromId;
                const contactName = msg.isSent ? msg.to : msg.from;

                if (!groupedMessages[contactId]) {
                    groupedMessages[contactId] = {
                        name: contactName,
                        messages: []
                    };
                }
                groupedMessages[contactId].messages.push(msg);
            });

            container.innerHTML = Object.entries(groupedMessages).map(([contactId, group]) => {
                const groupId = `msg-group-${contactId}`;
                // Sort messages within group by timestamp, newest first
                group.messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                const messagesHtml = group.messages.map(msg => {
                    const date = new Date(msg.timestamp);
                    const formattedDate = date.toLocaleString();
                    const isReset = msg.message.includes('PASSWORD RESET REQUEST');

                    return `
                        <div class="message-item ${msg.isSent ? 'sent' : 'received'} ${isReset ? 'reset-request' : ''}" style="margin-bottom: 10px;">
                            <div class="message-header">
                                <span class="message-direction">${msg.isSent ? 'üì§ Sent' : 'üì• Received'}</span>
                                <span class="message-date">${formattedDate}</span>
                            </div>
                            <div class="message-content">${msg.message.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="collapsible-group">
                        <div class="collapsible-header" data-group="${groupId}" onclick="toggleGroup('${groupId}')">
                            <h3>üë§ ${group.name} <span class="group-count">${group.messages.length}</span></h3>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div id="${groupId}" class="collapsible-content">
                            ${messagesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function handleLogout() {
            if (await showConfirm('üö™ Logout', 'Are you sure you want to logout?')) {
                auth.logout();
            }
        }


        window.closeChangeUsernameModal = function () {
            document.getElementById('change-username-modal').style.display = 'none';
        };

        window.submitUsernameChange = async function () {
            const newUsername = document.getElementById('new-username').value.trim();
            const errorEl = document.getElementById('username-error');
            const submitBtn = document.getElementById('submit-username-btn');

            if (!newUsername) {
                errorEl.textContent = 'Username cannot be empty';
                errorEl.style.display = 'block';
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Updating...';
                errorEl.style.display = 'none';

                await dataService.updateUsername(newUsername);

                await showAlert('Success', 'Username updated successfully!');

                // Update nav display if needed
                const navDisplay = document.getElementById('nav-user-display');
                if (navDisplay) navDisplay.textContent = `üë§ ${newUsername}`;

                closeChangeUsernameModal();
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to update username';
                errorEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Username';
            }
        };

        // UI Helpers
        window.toggleGroup = function (groupId) {
            const header = document.querySelector(`.collapsible-header[data-group="${groupId}"]`);
            const content = document.getElementById(groupId);
            if (header && content) {
                header.classList.toggle('active');
                content.classList.toggle('active');
            }
        };

        // Update nav display initially
        document.addEventListener('DOMContentLoaded', () => {
            const user = dataService.getCurrentUser();
            if (user && user.username) {
                const navDisplay = document.getElementById('nav-user-display');
                if (navDisplay) navDisplay.textContent = `üë§ ${user.username}`;
            }
        });

        // Change Password Functions
        window.openChangePasswordModal = function () {
            document.getElementById('change-password-modal').style.display = 'flex';
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            const errorEl = document.getElementById('password-error');
            if (errorEl) errorEl.style.display = 'none';
        };

        window.closeChangePasswordModal = function () {
            document.getElementById('change-password-modal').style.display = 'none';
        };

        window.togglePasswordVisibility = function (inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üîí';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        };

        window.submitPasswordChange = async function () {
            const oldPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-new-password').value;
            const errorEl = document.getElementById('password-error');
            const submitBtn = document.getElementById('submit-password-btn');

            if (!oldPass || !newPass || !confirmPass) {
                errorEl.textContent = 'Please fill in all fields';
                errorEl.style.display = 'block';
                return;
            }

            if (newPass !== confirmPass) {
                errorEl.textContent = 'New passwords do not match';
                errorEl.style.display = 'block';
                return;
            }

            if (newPass.length < 8) {
                errorEl.textContent = 'New password must be at least 8 characters';
                errorEl.style.display = 'block';
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Updating...';
                errorEl.style.display = 'none';

                await dataService.updatePassword(oldPass, newPass);

                await showAlert('Success', 'Password updated successfully! Please login again with your new password.');
                auth.logout();
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to update password';
                errorEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Password';
            }
        };

        // Credentials Dropdown Functions
        window.toggleCredentialsDropdown = function () {
            const content = document.getElementById('credentials-dropdown-content');
            content.classList.toggle('show');

            // Close when clicking outside
            const closeHandler = (e) => {
                if (!e.target.closest('.credentials-dropdown')) {
                    content.classList.remove('show');
                    document.removeEventListener('click', closeHandler);
                }
            };

            if (content.classList.contains('show')) {
                setTimeout(() => document.addEventListener('click', closeHandler), 10);
            }
        };

        // Change Username Functions
        window.openChangeUsernameModal = async function () {
            document.getElementById('change-username-modal').style.display = 'flex';
            document.getElementById('new-username').value = '';
            document.getElementById('username-error').style.display = 'none';
            document.getElementById('username-success').style.display = 'none';

            // Load and display current username
            try {
                const currentUsername = dataService.getUsername();
                document.getElementById('current-username-display').value = currentUsername;
            } catch (err) {
                console.error('Failed to get username:', err);
                document.getElementById('current-username-display').value = 'Loading...';
            }
        };

        window.closeChangeUsernameModal = function () {
            document.getElementById('change-username-modal').style.display = 'none';
        };

        window.submitUsernameChange = async function () {
            const newUsername = document.getElementById('new-username').value.trim();
            const errorEl = document.getElementById('username-error');
            const successEl = document.getElementById('username-success');
            const submitBtn = document.getElementById('submit-username-btn');

            if (!newUsername) {
                errorEl.textContent = 'Please enter a username';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            if (newUsername.length < 3) {
                errorEl.textContent = 'Username must be at least 3 characters';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            if (!/^[a-zA-Z0-9._-]+$/.test(newUsername)) {
                errorEl.textContent = 'Username can only contain letters, numbers, dots, underscores, and hyphens';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Updating...';
                errorEl.style.display = 'none';
                successEl.style.display = 'none';

                await dataService.updateUsername(newUsername);

                successEl.textContent = 'Username updated successfully!';
                successEl.style.display = 'block';
                document.getElementById('current-username-display').value = newUsername;

                setTimeout(() => {
                    closeChangeUsernameModal();
                }, 2000);
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to change username';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Username';
            }
        };
        window.showAlert = function (title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('alert-modal');
                document.getElementById('alert-title').innerHTML = title || 'Notice';
                document.getElementById('alert-message').innerHTML = message;

                const okBtn = document.getElementById('alert-ok-btn');
                okBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve();
                };
                modal.style.display = 'flex';
            });
        };

        window.showConfirm = function (title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-title').innerHTML = title || 'Confirm';
                document.getElementById('confirm-message').innerHTML = message;

                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                yesBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };
                noBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
                modal.style.display = 'flex';
            });
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
    </div>
</body>

</html>