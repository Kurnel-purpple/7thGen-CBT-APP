name: Build iOS App

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.2)'
        required: true
        default: '1.2.2'

# NOTE: iOS builds require:
# 1. An Apple Developer Account ($99/year) - https://developer.apple.com
# 2. A signing certificate and provisioning profile stored as GitHub Secrets:
#    - APPLE_CERTIFICATE (base64-encoded .p12 file)
#    - APPLE_CERTIFICATE_PASSWORD
#    - APPLE_PROVISIONING_PROFILE (base64-encoded .mobileprovision file)
# Until those are set up, this workflow builds an UNSIGNED archive (for testing only).

jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Add iOS platform (if not present)
        run: |
          if [ ! -d "ios" ]; then
            npx cap add ios
          fi

      - name: Sync Capacitor iOS project
        run: npx cap sync ios

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Build iOS (unsigned - for testing)
        run: |
          cd ios/App
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            archive

      - name: Export IPA (unsigned)
        run: |
          xcodebuild \
            -exportArchive \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath $RUNNER_TEMP/build \
            || echo "Export skipped - needs signing config"

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: ios-build
          path: |
            ${{ runner.temp }}/build/*.ipa
            ${{ runner.temp }}/App.xcarchive
          if-no-files-found: ignore
